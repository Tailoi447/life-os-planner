<!DOCTYPE html>
<html lang="vi">
<style>
    /* --- FIX GIAO DI·ªÜN MOBILE (D√°n v√†o cu·ªëi ph·∫ßn Style) --- */
    @media screen and (max-width: 900px) {
        /* 1. S·∫Øp x·∫øp l·∫°i b·ªë c·ª•c trang web th√†nh d·∫°ng d·ªçc */
        body {
            display: flex;
            flex-direction: column;
            padding: 10px !important;
            height: auto !important;
            overflow-x: hidden; /* Ch·∫∑n cu·ªôn ngang */
            align-items: center;
        }

        /* 2. Ch·ªânh t·ªù gi·∫•y Planner full m√†n h√¨nh */
        .planner {
            width: 100% !important;
            min-height: auto !important;
            padding: 15px !important;
            box-shadow: none !important;
            margin-bottom: 20px;
        }

        /* 3. Chuy·ªÉn c√°c c·ªôt th√†nh h√†ng d·ªçc */
        .main-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* 4. Fix ph·∫ßn Header ng√†y th√°ng */
        .header {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }
        .date-display {
            text-align: left;
            width: 100%;
        }

        /* 5. ƒê∆∞a Sidebar b√™n Ph·∫£i (Timer/Tools) xu·ªëng d∆∞·ªõi c√πng */
        .sidebar {
            position: relative !important; /* Kh√¥ng treo l∆° l·ª≠ng n·ªØa */
            width: 100% !important;
            right: auto !important;
            top: auto !important;
            bottom: auto !important;
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 10px;
            pointer-events: auto !important;
            z-index: 10;
        }
        
        /* 6. ƒê∆∞a Sidebar b√™n Tr√°i (Nh·∫°c) xu·ªëng d∆∞·ªõi c√πng */
        .sidebar-left {
            position: relative !important;
            width: 100% !important;
            left: auto !important;
            bottom: auto !important;
            margin-top: 20px;
            transform: none !important; /* T·∫Øt ch·∫ø ƒë·ªô thu nh·ªè */
        }

        /* ·∫®n n√∫t m≈©i t√™n thu nh·ªè nh·∫°c (v√¨ tr√™n mobile ƒë√£ d√†n ra h·∫øt r·ªìi) */
        .toggle-media-btn {
            display: none !important;
        }

        /* Ch·ªânh l·∫°i ƒë·ªô r·ªông c√°c Widget cho v·ª´a m√†n h√¨nh */
        .widget, .music-card {
            width: 100% !important;
            max-width: none !important;
        }

        /* 7. Fix C·ª≠a h√†ng XP v√† c√°c b·∫£ng Modal */
        .shop-box {
            width: 95% !important;
            height: 80vh !important; /* Chi·ªÅu cao 80% m√†n h√¨nh */
            max-height: 80vh !important;
        }
        
        .habit-grid {
            grid-template-columns: repeat(4, 1fr); /* Gi·ªØ nguy√™n 4 th√≥i quen */
            gap: 5px;
        }
    }
    /* --- CSS M·ªöI CHO SHOP TAB --- */
    .shop-tabs {
        display: flex;
        gap: 10px;
        padding: 0 20px 10px 20px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        background: rgba(255,255,255,0.05);
    }
    
    .tab-btn {
        background: transparent;
        border: none;
        color: var(--text-sub);
        padding: 8px 15px;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        border-bottom: 2px solid transparent;
        transition: 0.3s;
    }
    
    .tab-btn:hover { color: white; }
    
    .tab-btn.active {
        color: var(--accent);
        border-bottom-color: var(--accent);
    }

    /* Style hi·ªÉn th·ªã m√†u s·∫Øc c·ªßa Theme */
    .theme-preview-circle {
        width: 40px; height: 40px; border-radius: 50%;
        margin: 0 auto;
        box-shadow: 0 0 10px rgba(0,0,0,0.5);
        border: 2px solid white;
    }
</style>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life OS - God Mode</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --bg-body: #0f0f13;
            --paper-bg: #ffffff;
            --text-main: #2d3436;
            --text-sub: #636e72;
            --accent: #6c5ce7; /* M√†u t√≠m sang tr·ªçng h∆°n */
            --accent-hover: #a29bfe;
            --border: #dfe6e9;
            --success: #00b894;
            --danger: #ff7675;
            --warning: #fdcb6e;
            --glass: rgba(255, 255, 255, 0.08);
            --shadow-card: 0 10px 40px rgba(0,0,0,0.2);
        }

        [data-theme="dark"] {
            --paper-bg: #1e1e24;
            --text-main: #ecf0f1;
            --text-sub: #b2bec3;
            --accent: #a29bfe;
            --border: #353b48;
            --glass: rgba(0, 0, 0, 0.5);
        }

        * { box-sizing: border-box; transition: background 0.3s, color 0.3s, border-color 0.3s; }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-body);
            margin: 0; padding: 40px;
            display: flex; justify-content: center; min-height: 100vh;
            background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        /* --- FOCUS MODE --- */
        body.zen-mode .sidebar, 
        body.zen-mode .header, 
        body.zen-mode .progress-container { opacity: 0.1; filter: blur(4px); transition: 0.5s; pointer-events: none; }
        body.zen-mode .planner { box-shadow: 0 0 100px rgba(108, 92, 231, 0.3); }
        body.zen-mode .section:not(:hover) { opacity: 0.3; }

        /* --- PLANNER SHEET --- */
        .planner {
            width: 215mm; min-height: 297mm;
            background: var(--paper-bg); color: var(--text-main);
            padding: 15mm; border-radius: 12px;
            box-shadow: var(--shadow-card);
            position: relative; display: flex; flex-direction: column; gap: 25px;
        }

        /* Header */
        .header { display: flex; justify-content: space-between; align-items: flex-end; padding-bottom: 20px; border-bottom: 2px solid var(--border); }
        .brand h1 { font-size: 42px; font-weight: 800; letter-spacing: -1px; margin: 0; background: linear-gradient(45deg, var(--accent), #fd79a8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .date-display { font-size: 14px; color: var(--text-sub); font-weight: 500; text-align: right; }
        
        /* Mood Tracker */
        .mood-tracker { display: flex; gap: 10px; margin-top: 10px; }
        .mood-btn { font-size: 20px; cursor: pointer; opacity: 0.4; transition: 0.2s; filter: grayscale(1); }
        .mood-btn:hover, .mood-btn.active { opacity: 1; transform: scale(1.2); filter: grayscale(0); }

        /* Stats Bar */
        .stats-bar { display: flex; gap: 20px; background: rgba(0,0,0,0.03); padding: 10px 20px; border-radius: 8px; align-items: center; }
        .stat-item { display: flex; flex-direction: column; align-items: center; flex: 1; }
        .stat-val { font-weight: 800; font-size: 18px; color: var(--accent); }
        .stat-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-sub); }

        /* Grid Layout */
        .main-grid { display: grid; grid-template-columns: 1.2fr 1fr; gap: 40px; }

        /* Titles */
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .section-title { 
            font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; 
            color: var(--text-main); border-left: 4px solid var(--accent); padding-left: 10px; 
        }

        /* ROW STYLES & DRAG DROP */
        .row { 
            display: flex; align-items: center; padding: 8px; border-radius: 6px; 
            margin-bottom: 8px; background: rgba(255,255,255,0.01); border: 1px solid transparent;
        }
        .row:hover { background: rgba(0,0,0,0.02); border-color: var(--border); }
        .row.dragging { opacity: 0.5; background: var(--accent-hover); border: 2px dashed var(--accent); }
        
        .drag-handle { color: var(--border); cursor: grab; margin-right: 8px; font-size: 12px; opacity: 0; }
        .row:hover .drag-handle { opacity: 1; }

        .check-box {
            width: 18px; height: 18px; border: 2px solid var(--text-sub); border-radius: 4px;
            margin-right: 12px; cursor: pointer; position: relative; flex-shrink: 0;
        }
        .check-box.checked { background: var(--success); border-color: var(--success); }
        .check-box.checked::after { content: '‚úì'; color: white; position: absolute; top: -4px; left: 2px; font-size: 14px; font-weight: bold; }

        .input-text {
            flex: 1; background: transparent; border: none; font-family: inherit; font-size: 14px; 
            color: var(--text-main); outline: none; padding: 4px;
        }
        .check-box.checked + .input-text { text-decoration: line-through; opacity: 0.5; }

        /* Eisenhower Matrix (Hidden by default) */
        #eisenhower-view { display: none; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 10px; height: 400px; }
        .matrix-box { border: 1px solid var(--border); border-radius: 8px; padding: 10px; display: flex; flex-direction: column; }
        .matrix-box h4 { margin: 0 0 10px 0; font-size: 12px; opacity: 0.7; text-align: center; }
        .matrix-urgent { background: rgba(255, 118, 117, 0.1); }
        .matrix-schedule { background: rgba(9, 132, 227, 0.1); }
        .matrix-delegate { background: rgba(253, 203, 110, 0.1); }
        .matrix-delete { background: rgba(178, 190, 195, 0.1); }

        /* Habit Tracker */
        .habit-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .habit-item { 
            border: 1px solid var(--border); border-radius: 8px; padding: 10px; text-align: center; 
            cursor: pointer; transition: 0.2s; 
        }
        .habit-item.done { background: var(--accent); color: white; border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(108, 92, 231, 0.3); }
        .habit-icon { font-size: 18px; margin-bottom: 5px; display: block; }
        .habit-name { font-size: 11px; font-weight: 600; }

        /* SIDEBAR PRO */
        .sidebar { position: fixed; right: 20px; top: 20px; bottom: 20px; width: 320px; display: flex; flex-direction: column; gap: 15px; pointer-events: none; z-index: 999; }
        .widget { 
            background: var(--glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 15px;
            pointer-events: auto; color: white; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .timer-circle {
            width: 120px; height: 120px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.1);
            margin: 0 auto; display: flex; align-items: center; justify-content: center;
            font-size: 32px; font-weight: 800; position: relative;
        }
        .timer-circle::before {
            content: ''; position: absolute; top: -4px; left: -4px; right: -4px; bottom: -4px;
            border-radius: 50%; border: 4px solid var(--success); border-top-color: transparent; border-left-color: transparent;
            animation: spin 2s linear infinite; opacity: 0; transition: 0.3s;
        }
        .timer-running .timer-circle::before { opacity: 1; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Sound Mixer */
        .sound-board { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 10px; }
        .sound-btn { 
            background: rgba(255,255,255,0.1); border: none; padding: 10px; border-radius: 6px; 
            color: white; cursor: pointer; font-size: 14px; transition: 0.2s;
        }
        .sound-btn.active { background: var(--success); box-shadow: 0 0 10px var(--success); }

        /* Toast & Overlay */
        #toast-box { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 2000; }
        .toast { background: #2d3436; color: white; padding: 10px 20px; border-radius: 20px; margin-top: 10px; font-size: 13px; animation: popUp 0.3s; display: flex; align-items: center; gap: 8px; }
        @keyframes popUp { from{transform: translateY(20px); opacity:0} to{transform:translateY(0); opacity:1} }

        @media print {
            .sidebar, .drag-handle, .mood-tracker, .stats-bar { display: none !important; }
            body { padding: 0; background: white; }
            .planner { width: 100%; box-shadow: none; border: none; }
        }
    </style>
</head>
<body>

    <div id="toast-box"></div>

    <div class="planner" id="planner">
        <div class="header">
            <div class="brand">
                <h1>LIFE OS <span style="font-size:12px; color:var(--text-sub); vertical-align:middle; border:1px solid var(--accent); padding:2px 6px; border-radius:4px;">V3.0</span></h1>
                <div style="
    font-size: 11px; 
    font-weight: 700; 
    color: var(--accent); 
    letter-spacing: 2px; 
    text-transform: uppercase; 
    margin-top: 4px; 
    margin-bottom: 8px;
    display: flex; 
    align-items: center; 
    gap: 6px;
    opacity: 0.9;
">
    DESIGNED BY 
    <span style="background: var(--accent); color: white; padding: 2px 6px; border-radius: 4px;">
        Tailoi
    </span>
    <i class="fas fa-check-circle" title="Verified Owner"></i>
</div>
                <div class="mood-tracker">
                    <div class="mood-btn" onclick="setMood(this, 'fire')" title="Productive">üî•</div>
                    <div class="mood-btn" onclick="setMood(this, 'happy')" title="Happy">üòÑ</div>
                    <div class="mood-btn" onclick="setMood(this, 'neutral')" title="Normal">üòê</div>
                    <div class="mood-btn" onclick="setMood(this, 'tired')" title="Tired">üò¥</div>
                    <div class="mood-btn" onclick="setMood(this, 'sad')" title="Sad">üòû</div>
                </div>
            </div>
            <div class="date-display">
                <div style="font-size: 24px; font-weight: 800; color: var(--text-main)" id="day-name">MONDAY</div>
                <div id="full-date" contenteditable="true">October 24, 2023</div>
            </div>
        </div>

        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-val" id="progress-text">0%</div>
                <div class="stat-label">Ti·∫øn ƒê·ªô</div>
            </div>
            <div class="stat-item">
                <div class="stat-val" id="task-count">0/0</div>
                <div class="stat-label">C√¥ng Vi·ªác</div>
            </div>
            <div class="stat-item">
                <div class="stat-val" id="habit-count">0/4</div>
                <div class="stat-label">Th√≥i Quen</div>
            </div>
        </div>

        <div class="main-grid">
            <div class="col">
                <div class="section-header">
                    <span class="section-title"><i class="fas fa-running"></i> Habits</span>
                </div>
                <div class="habit-grid">
                    <div class="habit-item" id="h_read" onclick="toggleHabit('h_read')">
                        <i class="fas fa-book habit-icon"></i><span class="habit-name">ƒê·ªçc s√°ch</span>
                    </div>
                    <div class="habit-item" id="h_water" onclick="toggleHabit('h_water')">
                        <i class="fas fa-tint habit-icon"></i><span class="habit-name">2L N∆∞·ªõc</span>
                    </div>
                    <div class="habit-item" id="h_gym" onclick="toggleHabit('h_gym')">
                        <i class="fas fa-dumbbell habit-icon"></i><span class="habit-name">T·∫≠p Gym</span>
                    </div>
                    <div class="habit-item" id="h_med" onclick="toggleHabit('h_med')">
                        <i class="fas fa-spa habit-icon"></i><span class="habit-name">Thi·ªÅn</span>
                    </div>
                </div>

                <div class="section-header">
                    <span class="section-title"><i class="fas fa-star"></i> Ti√™u ƒêi·ªÉm Trong Ng√†y</span>
                </div>
                <div id="prio-list" class="drop-zone">
                    </div>

                <div class="section-header" style="margin-top: 30px">
                    <span class="section-title"><i class="fas fa-clock"></i> L·ªãch Tr√¨nh (Time Blocking)</span>
                </div>
                <div id="schedule-list">
                    </div>
            </div>

            <div class="col">
                <div class="section-header">
                    <span class="section-title"><i class="fas fa-check-double"></i> To-Do List</span>
                    <button onclick="toggleMatrix()" style="background:none; border:none; color:var(--accent); cursor:pointer; font-size:12px; font-weight:bold;">
                        <i class="fas fa-th-large"></i> Ch·∫ø ƒë·ªô Ma Tr·∫≠n
                    </button>
                </div>

                <div id="todo-list" class="drop-zone">
                    </div>

                <div id="eisenhower-view">
    <div class="matrix-box q1" id="quadrant-1" ondragover="allowDrop(event)" ondrop="dropToMatrix(event, 'q1')">
        <div class="matrix-header">
            <span><i class="fas fa-fire"></i> G·∫•p & Quan Tr·ªçng</span>
            <i class="fas fa-ellipsis-h" style="opacity:0.5"></i>
        </div>
        <div class="matrix-content" id="list-q1"></div>
    </div>

    <div class="matrix-box q2" id="quadrant-2" ondragover="allowDrop(event)" ondrop="dropToMatrix(event, 'q2')">
        <div class="matrix-header">
            <span><i class="fas fa-calendar-alt"></i> Quan Tr·ªçng (Ko G·∫•p)</span>
            <i class="fas fa-ellipsis-h" style="opacity:0.5"></i>
        </div>
        <div class="matrix-content" id="list-q2"></div>
    </div>

    <div class="matrix-box q3" id="quadrant-3" ondragover="allowDrop(event)" ondrop="dropToMatrix(event, 'q3')">
        <div class="matrix-header">
            <span><i class="fas fa-user-clock"></i> G·∫•p (Ko Quan Tr·ªçng)</span>
            <i class="fas fa-ellipsis-h" style="opacity:0.5"></i>
        </div>
        <div class="matrix-content" id="list-q3"></div>
    </div>

    <div class="matrix-box q4" id="quadrant-4" ondragover="allowDrop(event)" ondrop="dropToMatrix(event, 'q4')">
        <div class="matrix-header">
            <span><i class="fas fa-trash-alt"></i> Kh√¥ng G·∫•p & Ko QT</span>
            <i class="fas fa-ellipsis-h" style="opacity:0.5"></i>
        </div>
        <div class="matrix-content" id="list-q4"></div>
    </div>
</div>

                <div class="section-header" style="margin-top: 30px">
                    <span class="section-title"><i class="fas fa-brain"></i> Brain Dump / Ghi Ch√∫</span>
                </div>
                <div contenteditable="true" id="brain-dump" 
                     style="width:100%; height:150px; background:rgba(0,0,0,0.02); border:1px dashed var(--border); border-radius:8px; padding:15px; outline:none; font-size:14px; line-height:1.6;">
                </div>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="widget" id="timer-widget">
            <div class="widget-title"><i class="fas fa-stopwatch"></i> Focus Timer</div>
            <div class="timer-circle" id="timer-display">25:00</div>
            <div style="display:flex; justify-content:center; gap:10px; margin-top:15px;">
                <button onclick="timerAction('start')" class="sound-btn" style="background:var(--success)"><i class="fas fa-play"></i></button>
                <button onclick="timerAction('pause')" class="sound-btn"><i class="fas fa-pause"></i></button>
                <button onclick="timerAction('reset')" class="sound-btn" style="background:var(--danger)"><i class="fas fa-redo"></i></button>
            </div>
        </div>

        <div class="widget">
            <div class="widget-title"><i class="fas fa-headphones"></i> √Çm Thanh (Focus)</div>
            <div class="sound-board">
                <button class="sound-btn" onclick="toggleSound('rain', this)"><i class="fas fa-cloud-rain"></i> M∆∞a</button>
                <button class="sound-btn" onclick="toggleSound('cafe', this)"><i class="fas fa-coffee"></i> Cafe</button>
                <button class="sound-btn" onclick="toggleSound('fire', this)"><i class="fas fa-fire"></i> L·ª≠a</button>
            </div>
            <audio id="audio-rain" loop src="https://actions.google.com/sounds/v1/weather/rain_heavy_loud.ogg"></audio>
            <audio id="audio-cafe" loop src="https://actions.google.com/sounds/v1/ambiences/coffee_shop.ogg"></audio>
            <audio id="audio-fire" loop src="https://actions.google.com/sounds/v1/ambiences/fire.ogg"></audio>
        </div>

        <div class="widget">
            <div class="widget-title"><i class="fas fa-rocket"></i> C√¥ng C·ª•</div>
            <button class="sound-btn" style="width:100%; margin-bottom:5px; text-align:left;" onclick="toggleZenMode()">
                <i class="fas fa-eye"></i> Zen Mode (Si√™u T·∫≠p Trung)
            </button>
            <button class="sound-btn" style="width:100%; margin-bottom:5px; text-align:left;" onclick="toggleTheme()">
                <i class="fas fa-adjust"></i> ƒê·ªïi Giao Di·ªán (S√°ng/T·ªëi)
            </button>
            <button class="sound-btn" style="width:100%; margin-bottom:5px; text-align:left; color:#ff7675" onclick="clearData()">
                <i class="fas fa-trash"></i> Reset Ng√†y M·ªõi
            </button>
        </div>
    </div>

    <script>
        /* ============================
           LIFE OS V3.0 CORE LOGIC
           ============================ */

        let dragSrcEl = null;
        let timerInterval = null;
        let timeLeft = 25 * 60;

        // INIT
        window.onload = function() {
            initDate();
            renderLists();
            loadData();
            calculateStats();
            setupDragDrop();
        };

        function initDate() {
            const d = new Date();
            const days = ["SUNDAY", "MONDAY", "TUESDAY", "WEDNESDAY", "THURSDAY", "FRIDAY", "SATURDAY"];
            document.getElementById('day-name').innerText = days[d.getDay()];
            if(document.getElementById('full-date').innerText.includes('October')) {
                document.getElementById('full-date').innerText = d.toLocaleDateString('vi-VN', { day:'numeric', month:'long', year:'numeric'});
            }
        }

        // RENDER UI
        function renderLists() {
            // Prio
            const prio = document.getElementById('prio-list');
            prio.innerHTML = '';
            for(let i=0; i<3; i++) prio.innerHTML += createRow('prio', i);

            // Schedule (6h - 23h)
            const sched = document.getElementById('schedule-list');
            sched.innerHTML = '';
            for(let i=6; i<=23; i++) {
                sched.innerHTML += `
                <div class="row">
                    <div style="width:50px; font-weight:bold; color:var(--text-sub); font-size:12px">${i}:00</div>
                    <input class="input-text" id="sched_${i}" oninput="autoSave()">
                </div>`;
            }

            // Todo (Normal)
            const todo = document.getElementById('todo-list');
            todo.innerHTML = '';
            for(let i=0; i<10; i++) todo.innerHTML += createRow('todo', i);
        }

        function createRow(type, id) {
            return `
            <div class="row" draggable="true" id="${type}_row_${id}">
                <i class="fas fa-grip-vertical drag-handle"></i>
                <div class="check-box" id="${type}_cb_${id}" onclick="toggleCheck('${type}', ${id})"></div>
                <input class="input-text" id="${type}_txt_${id}" oninput="autoSave()" placeholder="Nh·∫≠p c√¥ng vi·ªác...">
                <i class="fas fa-times" style="cursor:pointer; opacity:0.3; font-size:12px" onclick="clearRow('${type}_txt_${id}', '${type}_cb_${id}')"></i>
            </div>`;
        }

        // INTERACTIONS
        function toggleCheck(type, id) {
            const cb = document.getElementById(`${type}_cb_${id}`);
            cb.classList.toggle('checked');
            calculateStats();
            autoSave();
            
            if(cb.classList.contains('checked')) {
                // Confetti if all todos done
                if(checkAllDone()) fireConfetti();
            }
        }

        function clearRow(txtId, cbId) {
            document.getElementById(txtId).value = '';
            document.getElementById(cbId).classList.remove('checked');
            autoSave();
            calculateStats();
        }

        function toggleHabit(id) {
            const el = document.getElementById(id);
            el.classList.toggle('done');
            calculateStats();
            autoSave();
        }

        function setMood(btn, mood) {
            document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            localStorage.setItem('todayMood', mood);
            showToast(`ƒê√£ ghi l·∫°i t√¢m tr·∫°ng: ${mood.toUpperCase()}`);
        }

        function calculateStats() {
            // Tasks
            const checkboxes = document.querySelectorAll('.check-box');
            const total = checkboxes.length;
            const checked = document.querySelectorAll('.check-box.checked').length;
            const percent = total ? Math.round((checked/total)*100) : 0;
            
            document.getElementById('progress-text').innerText = percent + "%";
            document.getElementById('task-count').innerText = `${checked}/${total}`;

            // Habits
            const habits = document.querySelectorAll('.habit-item');
            const habitsDone = document.querySelectorAll('.habit-item.done').length;
            document.getElementById('habit-count').innerText = `${habitsDone}/${habits.length}`;
        }

        function toggleMatrix() {
            const list = document.getElementById('todo-list');
            const matrix = document.getElementById('eisenhower-view');
            if(matrix.style.display === 'none' || !matrix.style.display) {
                list.style.display = 'none';
                matrix.style.display = 'grid';
                // Move items logic could be added here for complex apps, 
                // but for visual V3, we keep them separate or just show structure.
                showToast("Chuy·ªÉn sang ch·∫ø ƒë·ªô Ma Tr·∫≠n Eisenhower");
            } else {
                list.style.display = 'block';
                matrix.style.display = 'none';
            }
        }

        function toggleZenMode() {
            document.body.classList.toggle('zen-mode');
            showToast(document.body.classList.contains('zen-mode') ? "ƒê√£ b·∫≠t Zen Mode" : "ƒê√£ t·∫Øt Zen Mode");
        }

        // DRAG AND DROP LOGIC
        function setupDragDrop() {
            const rows = document.querySelectorAll('.row[draggable="true"]');
            rows.forEach(row => {
                row.addEventListener('dragstart', handleDragStart);
                row.addEventListener('dragover', handleDragOver);
                row.addEventListener('dragenter', handleDragEnter);
                row.addEventListener('dragleave', handleDragLeave);
                row.addEventListener('drop', handleDrop);
                row.addEventListener('dragend', handleDragEnd);
            });
        }

        function handleDragStart(e) {
            this.style.opacity = '0.4';
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragOver(e) {
            if (e.preventDefault) e.preventDefault();
            return false;
        }

        function handleDragEnter(e) {
            this.classList.add('dragging');
        }

        function handleDragLeave(e) {
            this.classList.remove('dragging');
        }

        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation();
            if (dragSrcEl !== this) {
                // Swap ID logic is complex, simpler to swap innerHTML for visual sort
                const srcHTML = dragSrcEl.innerHTML;
                const srcClass = dragSrcEl.className;
                
                dragSrcEl.innerHTML = this.innerHTML;
                this.innerHTML = srcHTML;
                
                // Re-attach events (lazy way: just reload page or re-init listeners)
                // For this V3 demo, we just swap content. 
                autoSave();
            }
            return false;
        }

        function handleDragEnd(e) {
            this.style.opacity = '1';
            document.querySelectorAll('.row').forEach(col => col.classList.remove('dragging'));
        }

        // TIMER & SOUND
        function timerAction(action) {
            const widget = document.getElementById('timer-widget');
            if(action === 'start') {
                if(timerInterval) return;
                widget.classList.add('timer-running');
                timerInterval = setInterval(() => {
                    timeLeft--;
                    const m = Math.floor(timeLeft / 60).toString().padStart(2,'0');
                    const s = (timeLeft % 60).toString().padStart(2,'0');
                    document.getElementById('timer-display').innerText = `${m}:${s}`;
                    if(timeLeft <= 0) {
                        timerAction('reset');
                        alert("H·∫øt gi·ªù!");
                    }
                }, 1000);
            } else if (action === 'pause') {
                clearInterval(timerInterval);
                timerInterval = null;
                widget.classList.remove('timer-running');
            } else { // reset
                timerAction('pause');
                timeLeft = 25 * 60;
                document.getElementById('timer-display').innerText = "25:00";
            }
        }

        function toggleSound(type, btn) {
            const audio = document.getElementById(`audio-${type}`);
            if(audio.paused) {
                audio.play();
                btn.classList.add('active');
            } else {
                audio.pause();
                btn.classList.remove('active');
            }
        }

        // DATA PERSISTENCE
        function autoSave() {
            const data = {
                inputs: {},
                checks: {},
                habits: [],
                notes: document.getElementById('brain-dump').innerHTML
            };

            document.querySelectorAll('.input-text').forEach(el => data.inputs[el.id] = el.value);
            document.querySelectorAll('.check-box').forEach(el => data.checks[el.id] = el.classList.contains('checked'));
            document.querySelectorAll('.habit-item').forEach(el => {
                if(el.classList.contains('done')) data.habits.push(el.id);
            });

            localStorage.setItem('LifeOS_V3', JSON.stringify(data));
        }

        function loadData() {
            const raw = localStorage.getItem('LifeOS_V3');
            if(!raw) return;
            const data = JSON.parse(raw);

            // Inputs
            for(let id in data.inputs) {
                const el = document.getElementById(id);
                if(el) el.value = data.inputs[id];
            }
            // Checks
            for(let id in data.checks) {
                const el = document.getElementById(id);
                if(el && data.checks[id]) el.classList.add('checked');
            }
            // Habits
            if(data.habits) {
                data.habits.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.classList.add('done');
                });
            }
            // Notes
            if(data.notes) document.getElementById('brain-dump').innerHTML = data.notes;
            
            // Mood
            const mood = localStorage.getItem('todayMood');
            if(mood) {
                document.querySelectorAll('.mood-btn').forEach(b => {
                    if(b.getAttribute('onclick').includes(mood)) b.classList.add('active');
                });
            }
        }

        function clearData() {
            if(confirm("X√≥a d·ªØ li·ªáu ƒë·ªÉ b·∫Øt ƒë·∫ßu ng√†y m·ªõi?")) {
                localStorage.removeItem('LifeOS_V3');
                localStorage.removeItem('todayMood');
                location.reload();
            }
        }

        // UTILS
        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            html.setAttribute('data-theme', current === 'dark' ? 'light' : 'dark');
        }

        function showToast(msg) {
            const box = document.getElementById('toast-box');
            const div = document.createElement('div');
            div.className = 'toast';
            div.innerHTML = `<i class="fas fa-info-circle"></i> ${msg}`;
            box.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        function checkAllDone() {
            const total = document.querySelectorAll('#prio-list .check-box').length;
            const checked = document.querySelectorAll('#prio-list .check-box.checked').length;
            return total > 0 && total === checked;
        }

        function fireConfetti() {
            confetti({
                particleCount: 100, spread: 70, origin: { y: 0.6 }
            });
        }
    </script>
</body>
<style>
    /* Khu v·ª±c Dashboard m·ªü r·ªông b√™n d∆∞·ªõi */
    #expansion-pack {
        margin-top: 40px;
        padding-top: 20px;
        border-top: 2px dashed var(--border);
        animation: fadeIn 1s ease;
    }

    /* 1. RPG BAR (Thanh kinh nghi·ªám) */
    .rpg-container {
        background: var(--bg-body);
        padding: 20px;
        border-radius: 12px;
        border: 1px solid var(--border);
        margin-bottom: 30px;
        color: var(--text-main);
        display: flex;
        align-items: center;
        gap: 20px;
        box-shadow: inset 0 0 20px rgba(0,0,0,0.2);
    }
    
    .level-badge {
        width: 80px; height: 80px;
        background: linear-gradient(135deg, #6c5ce7, #a29bfe);
        border-radius: 50%;
        display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        color: white; font-weight: bold;
        box-shadow: 0 0 15px rgba(108, 92, 231, 0.5);
        border: 4px solid rgba(255,255,255,0.2);
        flex-shrink: 0;
    }
    .lvl-num { font-size: 28px; line-height: 1; }
    .lvl-text { font-size: 10px; opacity: 0.8; text-transform: uppercase; }

    .xp-area { flex: 1; }
    .xp-info { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; font-weight: 600; }
    .xp-bar-bg {
        height: 12px; background: rgba(255,255,255,0.1); border-radius: 6px; overflow: hidden; border: 1px solid var(--border);
    }
    .xp-bar-fill {
        height: 100%; width: 0%;
        background: linear-gradient(90deg, #00b894, #00cec9);
        transition: width 0.5s ease;
        box-shadow: 0 0 10px #00b894;
    }

    /* 2. ANALYTICS CHART (Bi·ªÉu ƒë·ªì c·ªôt) */
    .analytics-box {
        background: var(--paper-bg);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.05);
    }
    .chart-grid {
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        height: 150px;
        padding-top: 20px;
        gap: 10px;
    }
    .bar-col {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }
    .bar-stick {
        width: 100%;
        max-width: 30px;
        background: var(--accent);
        border-radius: 4px 4px 0 0;
        opacity: 0.3;
        transition: height 1s, opacity 0.3s;
        min-height: 4px;
    }
    .bar-stick:hover { opacity: 1; transform: scaleY(1.05); }
    .bar-label { font-size: 10px; color: var(--text-sub); font-weight: 600; }
    
    @keyframes fadeIn { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
</style>

<div id="expansion-pack" class="planner-extension">
    
    <div class="rpg-container">
        <div class="level-badge" id="rpg-badge">
            <span class="lvl-text">LVL</span>
            <span class="lvl-num" id="lvl-num">1</span>
        </div>
        <div class="xp-area">
            <div class="xp-info">
                <span id="rank-title">Novice (T·∫≠p s·ª±)</span>
                <span id="xp-text">0 / 100 XP</span>
            </div>
            <div class="xp-bar-bg">
                <div class="xp-bar-fill" id="xp-bar"></div>
            </div>
            <div style="margin-top:5px; font-size:11px; opacity:0.6; font-style:italic">
                *Tip: Ho√†n th√†nh 1 vi·ªác = +10 XP. Ho√†n th√†nh Th√≥i quen = +20 XP.
            </div>
        </div>
    </div>

    <div class="analytics-box">
        <div class="section-title"><i class="fas fa-chart-bar"></i> Hi·ªáu su·∫•t 7 ng√†y qua</div>
        <div class="chart-grid" id="chart-bars">
            </div>
    </div>
</div>

<script>
    /* =======================================
       LOGIC M·ªû R·ªòNG (RPG & DATA)
       ======================================= */
    
    // 1. C·∫§U H√åNH RPG
    const RPG = {
        xp: 0,
        level: 1,
        xpToNext: 100,
        ranks: ["T·∫≠p S·ª±", "Si√™ng NƒÉng", "Chuy√™n Nghi·ªáp", "Tinh Anh", "B·∫≠c Th·∫ßy", "Huy·ªÅn Tho·∫°i", "GOD MODE"]
    };

    // 2. INIT & OVERRIDE
    // Ch·∫°y ngay khi paste code v√†o
    (function initExpansion() {
        // ƒê∆∞a kh·ªëi expansion v√†o trong planner (ƒë·ªÉ n√≥ n·∫±m c√πng khung gi·∫•y)
        const planner = document.getElementById('planner');
        const expansion = document.getElementById('expansion-pack');
        if(planner && expansion) {
            planner.appendChild(expansion); // Di chuy·ªÉn n√≥ v√†o trong t·ªù gi·∫•y
        }

        loadRPG();
        renderChart();
        updateRPGInterface();
        
        // Ghi ƒë√® h√†m toggleCheck c≈© ƒë·ªÉ th√™m logic XP
        // L∆∞u l·∫°i h√†m c≈© n·∫øu c·∫ßn, nh∆∞ng ·ªü ƒë√¢y ta vi·∫øt l·∫°i logic b·ªçc ngo√†i
        const originalToggleCheck = window.toggleCheck;
        window.toggleCheck = function(type, id) {
            // G·ªçi logic c≈© (ƒë·ªÉ ƒë√°nh d·∫•u tick, l∆∞u data...)
            const cb = document.getElementById(`${type}_cb_${id}`);
            const wasChecked = cb.classList.contains('checked');
            
            // Ch·∫°y logic giao di·ªán c≈©
            cb.classList.toggle('checked');
            calculateStats();
            autoSave();

            // LOGIC M·ªöI: T√≠nh XP
            const isNowChecked = cb.classList.contains('checked');
            if (isNowChecked) {
                gainXP(10); 
                showToast(`+10 XP (C√¥ng vi·ªác)`);
            } else {
                gainXP(-10); // B·ªè tick th√¨ tr·ª´ XP
            }

            // Check confetti c≈©
            if(isNowChecked && checkAllDone()) fireConfetti();
        };

        // Ghi ƒë√® h√†m toggleHabit c≈©
        const originalToggleHabit = window.toggleHabit;
        window.toggleHabit = function(id) {
            const el = document.getElementById(id);
            const wasDone = el.classList.contains('done');
            
            el.classList.toggle('done');
            calculateStats();
            autoSave();

            if (!wasDone) {
                gainXP(20);
                showToast(`+20 XP (Th√≥i quen t·ªët!)`);
            } else {
                gainXP(-20);
            }
        };

    })();

    // 3. H√ÄM X·ª¨ L√ù RPG
    function gainXP(amount) {
        RPG.xp += amount;
        if(RPG.xp < 0) RPG.xp = 0;

        // Level Up Logic
        if (RPG.xp >= RPG.xpToNext) {
            RPG.xp = RPG.xp - RPG.xpToNext;
            RPG.level++;
            RPG.xpToNext = Math.floor(RPG.xpToNext * 1.2); // C√†ng l√™n cao c√†ng kh√≥
            levelUpEffect();
        }

        saveRPG();
        updateRPGInterface();
    }

    function updateRPGInterface() {
        document.getElementById('lvl-num').innerText = RPG.level;
        document.getElementById('xp-text').innerText = `${Math.floor(RPG.xp)} / ${RPG.xpToNext} XP`;
        
        const percent = (RPG.xp / RPG.xpToNext) * 100;
        document.getElementById('xp-bar').style.width = `${percent}%`;

        // Rank Title
        const rankIndex = Math.min(RPG.level - 1, RPG.ranks.length - 1);
        document.getElementById('rank-title').innerText = RPG.ranks[rankIndex];
    }

    function levelUpEffect() {
        showToast(`üéâ LEVEL UP! B·∫°n ƒë√£ ƒë·∫°t c·∫•p ${RPG.level}!`);
        // B·∫Øn ph√°o hoa to h∆°n
        var duration = 2 * 1000;
        var end = Date.now() + duration;
        (function frame() {
            confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 } });
            confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 } });
            if (Date.now() < end) requestAnimationFrame(frame);
        }());
    }

    function saveRPG() {
        const data = { xp: RPG.xp, level: RPG.level, xpToNext: RPG.xpToNext };
        localStorage.setItem('LifeOS_RPG', JSON.stringify(data));
        
        // L∆∞u l·ªãch s·ª≠ cho Chart (Gi·∫£ l·∫≠p l∆∞u nƒÉng su·∫•t h√¥m nay)
        saveDailyStats();
    }

    function loadRPG() {
        const raw = localStorage.getItem('LifeOS_RPG');
        if(raw) {
            const data = JSON.parse(raw);
            RPG.xp = data.xp || 0;
            RPG.level = data.level || 1;
            RPG.xpToNext = data.xpToNext || 100;
        }
    }

    // 4. LOGIC BI·ªÇU ƒê·ªí (CHART)
    function saveDailyStats() {
        // L·∫•y ng√†y h√¥m nay l√†m key
        const todayKey = new Date().toLocaleDateString('vi-VN');
        const totalTask = document.querySelectorAll('.check-box').length || 1;
        const doneTask = document.querySelectorAll('.check-box.checked').length || 0;
        const percent = Math.round((doneTask / totalTask) * 100);

        let history = JSON.parse(localStorage.getItem('LifeOS_History') || '{}');
        history[todayKey] = percent;
        localStorage.setItem('LifeOS_History', JSON.stringify(history));
        
        // V·∫Ω l·∫°i chart ngay khi save
        renderChart();
    }

    function renderChart() {
        const container = document.getElementById('chart-bars');
        container.innerHTML = '';
        
        // L·∫•y 7 ng√†y g·∫ßn nh·∫•t
        const history = JSON.parse(localStorage.getItem('LifeOS_History') || '{}');
        const days = [];
        
        for(let i=6; i>=0; i--) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            const key = d.toLocaleDateString('vi-VN');
            const shortName = d.toLocaleDateString('vi-VN', {weekday: 'short'}); // T2, T3...
            
            // N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu ng√†y c≈© th√¨ random nh·∫π cho ƒë·∫πp (Demo mode), 
            // Th·ª±c t·∫ø b·∫°n b·ªè d√≤ng '|| Math.random...' ƒëi n·∫øu mu·ªën ch√≠nh x√°c tuy·ªát ƒë·ªëi
            const val = history[key] || (key === new Date().toLocaleDateString('vi-VN') ? 0 : 5 + Math.floor(Math.random()*30)); 
            
            days.push({ day: shortName, val: val });
        }

        days.forEach(d => {
            const color = d.val >= 80 ? '#00b894' : (d.val >= 50 ? '#0984e3' : '#ff7675');
            container.innerHTML += `
                <div class="bar-col">
                    <div style="font-size:9px; margin-bottom:5px; opacity:0.7">${d.val}%</div>
                    <div class="bar-stick" style="height: ${d.val}%; background: ${color}; opacity: 0.8"></div>
                    <div class="bar-label">${d.day}</div>
                </div>
            `;
        });
    }

    // T·ª± ƒë·ªông l∆∞u th·ªëng k√™ m·ªói khi t·∫£i trang
    // ƒê·ªÉ ƒë·∫£m b·∫£o ng√†y h√¥m nay lu√¥n xu·∫•t hi·ªán
    saveDailyStats();

</script>
</html>
<style>
    /* UI cho Mixer Board */
    .mixer-board {
        margin-top: 15px;
        background: rgba(0,0,0,0.2);
        border-radius: 8px;
        padding: 10px;
        border: 1px solid rgba(255,255,255,0.1);
    }
    
    .mixer-row {
        display: flex; align-items: center; justify-content: space-between;
        margin-bottom: 8px; font-size: 12px; color: var(--text-sub);
    }
    
    .mixer-slider {
        -webkit-appearance: none; width: 60%; height: 4px; background: var(--border);
        border-radius: 2px; outline: none; opacity: 0.7; transition: .2s;
    }
    .mixer-slider:hover { opacity: 1; }
    .mixer-slider::-webkit-slider-thumb {
        -webkit-appearance: none; appearance: none;
        width: 12px; height: 12px; border-radius: 50%;
        background: var(--accent); cursor: pointer;
    }

    .sfx-toggle {
        cursor: pointer; padding: 2px 6px; border-radius: 4px; border: 1px solid transparent;
    }
    .sfx-toggle.muted { color: var(--danger); border-color: var(--danger); opacity: 0.7; }
    .sfx-toggle.active { color: var(--success); border-color: var(--success); }

</style>

<script>
    /* =======================================
       SONIC ENGINE (WEB AUDIO API)
       ======================================= */
    
    const AUDIO_SYS = {
        ctx: new (window.AudioContext || window.webkitAudioContext)(),
        volSFX: 0.3,  // √Çm l∆∞·ª£ng hi·ªáu ·ª©ng m·∫∑c ƒë·ªãnh
        volAmb: 0.5,  // √Çm l∆∞·ª£ng m√¥i tr∆∞·ªùng m·∫∑c ƒë·ªãnh
        isMuted: false,
        
        // T·∫°o √¢m thanh t·ª´ s√≥ng ƒëi·ªán t·ª≠ (Kh√¥ng c·∫ßn file mp3)
        playTone: function(freq, type, duration, vol = 1) {
            if(this.isMuted) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            
            osc.type = type; // 'sine', 'square', 'sawtooth', 'triangle'
            osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
            
            gain.gain.setValueAtTime(this.volSFX * vol, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);

            osc.connect(gain);
            gain.connect(this.ctx.destination);
            
            osc.start();
            osc.stop(this.ctx.currentTime + duration);
        },

        // B·ªô th∆∞ vi·ªán √¢m thanh
        sfx: {
            hover: () => AUDIO_SYS.playTone(400, 'sine', 0.05, 0.2), // Ti·∫øng 'tictac' nh·∫π khi l∆∞·ªõt chu·ªôt
            click: () => AUDIO_SYS.playTone(600, 'triangle', 0.1, 0.5), // Ti·∫øng click ƒëanh
            type: () => AUDIO_SYS.playTone(800 + Math.random()*200, 'sine', 0.05, 0.3), // Ti·∫øng g√µ ph√≠m c∆° (ng·∫´u nhi√™n t·∫ßn s·ªë)
            
            success: () => { // H·ª£p √¢m chi·∫øn th·∫Øng (C Major Arpeggio)
                if(AUDIO_SYS.isMuted) return;
                const now = AUDIO_SYS.ctx.currentTime;
                [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
                    setTimeout(() => AUDIO_SYS.playTone(freq, 'sine', 0.3, 0.6), i * 80);
                });
            },
            
            delete: () => AUDIO_SYS.playTone(150, 'sawtooth', 0.3, 0.5), // Ti·∫øng x√≥a 'b·ª•p'
            
            levelUp: () => { // Fanfare ho√†nh tr√°ng
                if(AUDIO_SYS.isMuted) return;
                const notes = [440, 554, 659, 880];
                notes.forEach((f, i) => {
                    setTimeout(() => AUDIO_SYS.playTone(f, 'square', 0.4, 0.4), i * 100);
                });
                setTimeout(() => AUDIO_SYS.playTone(880, 'square', 1.0, 0.5), 400);
            }
        }
    };

    // 1. G·∫ÆN GIAO DI·ªÜN MIXER V√ÄO SIDEBAR
    (function injectAudioUI() {
        const sidebar = document.querySelector('.sidebar');
        if(!sidebar) return;

        // T·∫°o Widget m·ªõi
        const widget = document.createElement('div');
        widget.className = 'widget';
        widget.innerHTML = `
            <div class="widget-title">
                <i class="fas fa-sliders-h"></i> √Çm Thanh
                <i class="fas fa-volume-up sfx-toggle active" id="master-mute" onclick="toggleMasterMute(this)" style="margin-left:auto"></i>
            </div>
            
            <div class="sound-board">
                <button class="sound-btn" onclick="toggleAmbience('rain', this)"><i class="fas fa-cloud-rain"></i></button>
                <button class="sound-btn" onclick="toggleAmbience('cafe', this)"><i class="fas fa-coffee"></i></button>
                <button class="sound-btn" onclick="toggleAmbience('fire', this)"><i class="fas fa-fire"></i></button>
            </div>

            <div class="mixer-board">
                <div class="mixer-row">
                    <span><i class="fas fa-music"></i> Nh·∫°c n·ªÅn</span>
                    <input type="range" class="mixer-slider" min="0" max="1" step="0.1" value="0.5" oninput="setVolume('amb', this.value)">
                </div>
                <div class="mixer-row">
                    <span><i class="fas fa-magic"></i> Hi·ªáu ·ª©ng</span>
                    <input type="range" class="mixer-slider" min="0" max="1" step="0.1" value="0.3" oninput="setVolume('sfx', this.value)">
                </div>
            </div>
        `;
        
        // Ch√®n v√†o ƒë·∫ßu sidebar ho·∫∑c sau widget timer
        const timerWidget = document.getElementById('timer-widget');
        if(timerWidget) timerWidget.after(widget);
        else sidebar.appendChild(widget);

        // K√≠ch ho·∫°t AudioContext khi ng∆∞·ªùi d√πng t∆∞∆°ng t√°c l·∫ßn ƒë·∫ßu (tr√¨nh duy·ªát b·∫Øt bu·ªôc)
        document.body.addEventListener('click', () => {
            if(AUDIO_SYS.ctx.state === 'suspended') AUDIO_SYS.ctx.resume();
        }, {once:true});
    })();

    // 2. LOGIC ƒêI·ªÄU KHI·ªÇN
    function toggleMasterMute(btn) {
        AUDIO_SYS.isMuted = !AUDIO_SYS.isMuted;
        if(AUDIO_SYS.isMuted) {
            btn.className = "fas fa-volume-mute sfx-toggle muted";
            // T·∫Øt nh·∫°c n·ªÅn n·∫øu ƒëang ch·∫°y
            document.querySelectorAll('audio').forEach(a => a.muted = true);
        } else {
            btn.className = "fas fa-volume-up sfx-toggle active";
            document.querySelectorAll('audio').forEach(a => a.muted = false);
            AUDIO_SYS.sfx.click(); // Test sound
        }
    }

    /* --- C·∫¨P NH·∫¨T LOGIC √ÇM THANH (FIX L·ªñI KH√îNG TI·∫æNG) --- */

function toggleAmbience(type, btn) {
    // 1. T·∫Øt c√°c √¢m thanh kh√°c ƒëang ch·∫°y
    document.querySelectorAll('audio').forEach(a => {
        if(a.id !== `audio-${type}`) {
            a.pause();
            a.currentTime = 0; // Tua v·ªÅ ƒë·∫ßu
        }
    });

    // 2. T·∫Øt tr·∫°ng th√°i active c·ªßa c√°c n√∫t kh√°c
    document.querySelectorAll('.sound-board .sound-btn').forEach(b => {
        if(b !== btn) b.classList.remove('active');
    });

    // 3. X·ª≠ l√Ω √¢m thanh ƒë∆∞·ª£c ch·ªçn
    const audio = document.getElementById(`audio-${type}`);
    if(!audio) return; // Ph√≤ng tr∆∞·ªùng h·ª£p kh√¥ng t√¨m th·∫•y th·∫ª audio

    // C·∫≠p nh·∫≠t volume ngay l·∫≠p t·ª©c theo thanh tr∆∞·ª£t
    audio.volume = AUDIO_SYS.volAmb;

    if(audio.paused) {
        // B·∫≠t l√™n
        const playPromise = audio.play();
        
        // X·ª≠ l√Ω l·ªói n·∫øu tr√¨nh duy·ªát ch·∫∑n (Autoplay Policy)
        if (playPromise !== undefined) {
            playPromise.then(_ => {
                // Ph√°t th√†nh c√¥ng
                btn.classList.add('active');
                showToast(`ƒêang ph√°t: ${type === 'rain' ? 'M∆∞a r∆°i' : (type === 'cafe' ? 'Qu√°n Cafe' : 'L·ª≠a tr·∫°i')}`);
            })
            .catch(error => {
                // L·ªói ch·∫∑n ph√°t
                console.error("L·ªói ph√°t nh·∫°c:", error);
                btn.classList.remove('active');
                alert("‚ö†Ô∏è Tr√¨nh duy·ªát ƒëang ch·∫∑n ph√°t ti·∫øng. H√£y click chu·ªôt v√†o trang web m·ªôt l·∫ßn r·ªìi th·ª≠ l·∫°i!");
            });
        }
    } else {
        // ƒêang ph√°t th√¨ t·∫Øt ƒëi
        audio.pause();
        btn.classList.remove('active');
    }
}

// H√†m c·∫≠p nh·∫≠t Volume (ƒë·∫£m b·∫£o c·∫≠p nh·∫≠t realtime)
function setVolume(type, val) {
    if(type === 'sfx') {
        AUDIO_SYS.volSFX = parseFloat(val);
        AUDIO_SYS.sfx.click(); // K√™u th·ª≠ 1 ti·∫øng
    } else {
        AUDIO_SYS.volAmb = parseFloat(val);
        // C·∫≠p nh·∫≠t ngay l·∫≠p t·ª©c cho audio ƒëang ch·∫°y
        document.querySelectorAll('audio').forEach(a => {
            a.volume = AUDIO_SYS.volAmb;
        });
    }
}

    // 3. G·∫ÆN HI·ªÜU ·ª®NG V√ÄO H√ÄNH ƒê·ªòNG C≈®
    (function attachSoundHooks() {
        // Hook v√†o h√†m toggleCheck (Tick vi·ªác)
        const oldToggleCheck = window.toggleCheck;
        window.toggleCheck = function(type, id) {
            oldToggleCheck(type, id); // Ch·∫°y logic c≈©
            
            const cb = document.getElementById(`${type}_cb_${id}`);
            if(cb.classList.contains('checked')) {
                AUDIO_SYS.sfx.success(); // Sound chi·∫øn th·∫Øng
            } else {
                AUDIO_SYS.sfx.click(); // Sound h·ªßy
            }
        };

        // Hook v√†o h√†m toggleHabit (Th√≥i quen)
        const oldToggleHabit = window.toggleHabit;
        window.toggleHabit = function(id) {
            oldToggleHabit(id);
            const el = document.getElementById(id);
            if(el.classList.contains('done')) AUDIO_SYS.sfx.success();
            else AUDIO_SYS.sfx.click();
        };

        // Hook v√†o h√†m clearRow (X√≥a)
        const oldClearRow = window.clearRow;
        window.clearRow = function(t, c) {
            oldClearRow(t, c);
            AUDIO_SYS.sfx.delete();
        };

        // Hook v√†o Level Up (N·∫øu ƒë√£ c√†i Expansion 1)
        const oldLevelUp = window.levelUpEffect;
        if(oldLevelUp) {
            window.levelUpEffect = function() {
                oldLevelUp();
                AUDIO_SYS.sfx.levelUp();
            };
        }

        // Mechanical Keyboard Effect (G√µ ph√≠m)
        document.addEventListener('keydown', (e) => {
            // Ch·ªâ k√™u khi g√µ v√†o √¥ input
            if(e.target.tagName === 'INPUT' || e.target.getAttribute('contenteditable') === 'true') {
                if(e.key.length === 1 || e.key === 'Backspace' || e.key === 'Enter') {
                    AUDIO_SYS.sfx.type();
                }
            }
        });

        // Hover Effect cho buttons
        document.querySelectorAll('.btn, .check-box, .habit-item, .sound-btn').forEach(el => {
            el.addEventListener('mouseenter', () => AUDIO_SYS.sfx.hover());
        });

    })();
</script>
<style>
    /* Sidebar b√™n tr√°i */
    .sidebar-left {
        position: fixed; left: 20px; bottom: 20px; width: 320px;
        display: flex; flex-direction: column; gap: 15px; z-index: 999;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .sidebar-left.minimized { transform: translateX(-330px); }
    .sidebar-left.minimized .toggle-media-btn {
        transform: translateX(340px); background: var(--accent); color: white;
    }
    
    .toggle-media-btn {
        position: absolute; right: -15px; top: 15px; width: 30px; height: 30px;
        background: var(--bg-body); border: 1px solid var(--border); border-radius: 50%;
        display: flex; align-items: center; justify-content: center; cursor: pointer;
        z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: 0.3s; color: var(--text-sub);
    }
    .toggle-media-btn:hover { transform: scale(1.1); color: var(--accent); }

    /* GIAO DI·ªÜN PLAYER */
    .music-card {
        background: linear-gradient(145deg, #1e1e2e, #000000);
        border-radius: 16px; padding: 15px;
        border: 1px solid rgba(255,255,255,0.1);
        color: white; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        display: flex; flex-direction: column; gap: 10px;
        max-height: 520px;
    }

    .now-playing-area {
        text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);
        padding-bottom: 10px; margin-bottom: 5px;
    }
    .vinyl-record {
        width: 80px; height: 80px; border-radius: 50%;
        background: radial-gradient(#111 20%, #333 21%, #111 22%, #333 60%, #111 100%);
        margin: 0 auto 10px; position: relative;
        border: 2px solid rgba(255,255,255,0.1);
        animation: spin 5s linear infinite; animation-play-state: paused;
        transition: 0.5s;
    }
    .vinyl-record::after {
        content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 24px; height: 24px; background: var(--accent); border-radius: 50%; border: 2px solid #fff;
    }
    .vinyl-record.playing { animation-play-state: running; }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    .track-info h3 { margin: 0; font-size: 13px; color: var(--accent); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .track-info p { margin: 2px 0 0; font-size: 10px; color: #b2bec3; }

    .player-controls { display: flex; justify-content: center; gap: 15px; margin: 10px 0; }
    .ctrl-btn { background: transparent; border: none; color: white; cursor: pointer; font-size: 14px; opacity: 0.8; }
    .play-btn { width: 36px; height: 36px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; opacity: 1; }

    /* Playlist Scroll */
    .playlist-scroll {
        flex: 1; overflow-y: auto; padding-right: 5px;
        max-height: 160px;
        border-top: 1px dashed rgba(255,255,255,0.2);
        padding-top: 10px;
    }
    .playlist-scroll::-webkit-scrollbar { width: 4px; }
    .playlist-scroll::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 2px; }

    .song-item {
        display: flex; justify-content: space-between; align-items: center;
        padding: 6px 8px; border-radius: 4px; background: rgba(255,255,255,0.03);
        margin-bottom: 4px; font-size: 11px; cursor: pointer; transition: 0.2s;
    }
    .song-item:hover { background: rgba(255,255,255,0.1); }
    .song-item.active { background: rgba(9, 132, 227, 0.2); border-left: 3px solid var(--accent); }
    .song-item.error { color: #ff7675; text-decoration: line-through; opacity: 0.6; }
    
    .song-info { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: left; }
    .del-btn { color: #ff7675; padding: 2px 6px; font-size: 10px; }
    .del-btn:hover { background: rgba(255,0,0,0.2); border-radius: 4px; }

    .add-song-area { display: flex; gap: 5px; margin-top: 5px; }
    .custom-input { flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 4px; border-radius: 4px; font-size: 10px; outline: none; }
    .add-btn { background: var(--success); border: none; padding: 0 10px; border-radius: 4px; color: white; cursor: pointer; font-size: 10px; }
    
    .reset-btn { width: 100%; background: #2d3436; border: 1px solid var(--border); color: #ff7675; padding: 6px; font-size: 10px; margin-top: 5px; cursor: pointer; border-radius: 4px; opacity: 0.7; font-weight: bold; }
    .reset-btn:hover { opacity: 1; border-color: #ff7675; background: rgba(255, 118, 117, 0.1); }

</style>

<div class="sidebar-left" id="media-sidebar">
    <div class="toggle-media-btn" onclick="toggleMediaSidebar()">
        <i class="fas fa-chevron-right" id="media-icon" style="display:none"></i>
        <i class="fas fa-chevron-left" id="media-icon-close"></i>
    </div>

    <div class="music-card">
        <div class="now-playing-area">
            <div class="vinyl-record" id="vinyl"></div>
            <div class="track-info">
                <h3 id="track-name">Ch·ªçn b√†i h√°t...</h3>
                <p id="track-artist">Life OS Music</p>
            </div>
    <div class="progress-container">
    <input type="range" id="seek-bar" value="0" class="seek-slider" oninput="seekAudio()">
    <div class="time-row">
        <span id="curr-time">0:00</span>
        <span id="total-dur">0:00</span>
    </div>
</div>        
            <div class="player-controls">
    <button class="ctrl-btn repeat-btn repeat-all" id="btn-repeat" onclick="toggleRepeat()" title="Ch·∫ø ƒë·ªô l·∫∑p">
        <i class="fas fa-redo"></i>
    </button>

    <button class="ctrl-btn" onclick="prevSong()"><i class="fas fa-step-backward"></i></button>
    
    <button class="ctrl-btn play-btn" onclick="togglePlayMusic()" style="transform: scale(1.1);">
        <i class="fas fa-play" id="play-icon"></i>
    </button>
    
    <button class="ctrl-btn" onclick="nextSong()"><i class="fas fa-step-forward"></i></button>
    
    <button class="ctrl-btn" onclick="shufflePlaylist()" title="Tr·ªôn b√†i" style="opacity:0.5">
        <i class="fas fa-random"></i>
    </button>
</div>
        </div>

        <div style="font-size:10px; font-weight:bold; color:var(--text-sub); display:flex; justify-content:space-between">
            <span>DANH S√ÅCH PH√ÅT</span>
            <span id="total-songs">0 b√†i</span>
        </div>
        
        <div class="playlist-scroll" id="playlist-container"></div>

        <div class="add-song-area">
            <input id="new-song-name" class="custom-input" placeholder="T√™n b√†i...">
            <input id="new-song-url" class="custom-input" placeholder="Link MP3...">
            <button class="add-btn" onclick="addCustomSong()"><i class="fas fa-plus"></i></button>
        </div>
        
        <button class="reset-btn" onclick="resetPlayer()"><i class="fas fa-sync-alt"></i> RESET (S·ª≠a l·ªói link h·ªèng)</button>

        <audio id="main-audio" crossorigin="anonymous"></audio>
    </div>
</div>

<script>
    /* =======================================
       MUSIC MANAGER V5.1 (STABLE LINKS)
       ======================================= */
    
    // Ngu·ªìn nh·∫°c ·ªïn ƒë·ªãnh h∆°n (Google + Pixabay Updated)
    const DEFAULT_SONGS = [
        { 
            name: "Lofi Jazz Rain", 
            artist: "Relaxing Vibes", 
            src: "https://cdn.pixabay.com/audio/2022/11/22/audio_febc508520.mp3", 
            isDefault: true 
        },
        { 
            name: "Heavy Rain (Focus)", 
            artist: "Nature Sound", 
            src: "https://actions.google.com/sounds/v1/weather/rain_heavy_loud.ogg", 
            isDefault: true 
        },
        { 
            name: "Coffee Shop", 
            artist: "Ambience", 
            src: "https://actions.google.com/sounds/v1/ambiences/coffee_shop.ogg", 
            isDefault: true 
        }
    ];

    let fullPlaylist = [];
    let currentIdx = 0;
    
    const audio = document.getElementById('main-audio');
    const vinyl = document.getElementById('vinyl');
    const playIcon = document.getElementById('play-icon');
    const playBtn = document.querySelector('.play-btn');

    function initMusicPlayer() {
        loadPlaylistData();
        renderPlaylistUI();
        loadSong(0, false);
    }

    function loadPlaylistData() {
        const stored = localStorage.getItem('my_full_playlist');
        if(stored) {
            try {
                fullPlaylist = JSON.parse(stored);
                // N·∫øu playlist r·ªóng ho·∫∑c l·ªói, d√πng m·∫∑c ƒë·ªãnh
                if(!Array.isArray(fullPlaylist) || fullPlaylist.length === 0) {
                    fullPlaylist = [...DEFAULT_SONGS];
                }
            } catch(e) { fullPlaylist = [...DEFAULT_SONGS]; }
        } else {
            fullPlaylist = [...DEFAULT_SONGS];
        }
    }

    function savePlaylistData() {
        localStorage.setItem('my_full_playlist', JSON.stringify(fullPlaylist));
        renderPlaylistUI();
    }

    function renderPlaylistUI() {
        const container = document.getElementById('playlist-container');
        container.innerHTML = '';
        document.getElementById('total-songs').innerText = `${fullPlaylist.length} b√†i`;

        fullPlaylist.forEach((song, index) => {
            const item = document.createElement('div');
            item.className = `song-item ${index === currentIdx ? 'active' : ''}`;
            
            let html = `<div class="song-info" onclick="playSongAtIndex(${index})">
                            <i class="fas fa-music" style="margin-right:5px; opacity:0.5"></i>
                            <b>${song.name}</b> <span style="opacity:0.7">- ${song.artist}</span>
                        </div>`;
            
            if(!song.isDefault) {
                html += `<div class="del-btn" onclick="deleteSong(${index}, event)"><i class="fas fa-trash"></i></div>`;
            }
            item.innerHTML = html;
            container.appendChild(item);
        });
    }

    function loadSong(index, autoPlay) {
        if(index < 0) index = fullPlaylist.length - 1;
        if(index >= fullPlaylist.length) index = 0;
        
        currentIdx = index;
        const song = fullPlaylist[currentIdx];
        
        document.getElementById('track-name').innerText = song.name;
        document.getElementById('track-artist').innerText = song.artist;
        audio.src = song.src;

        renderPlaylistUI();

        if(autoPlay) {
            audio.play().catch(e => {
                console.log("Autoplay prevented or Link Error");
                updatePlayState(false);
            });
        }
    }

    function playSongAtIndex(index) { loadSong(index, true); }

    function togglePlayMusic() {
        if(audio.paused) {
            audio.play().catch(() => alert("Click v√†o trang web 1 l·∫ßn ƒë·ªÉ k√≠ch ho·∫°t √¢m thanh!"));
        } else {
            audio.pause();
        }
    }

    function nextSong() { loadSong(currentIdx + 1, true); }
    function prevSong() { loadSong(currentIdx - 1, true); }

    function addCustomSong() {
        const name = document.getElementById('new-song-name').value.trim();
        const url = document.getElementById('new-song-url').value.trim();
        if(!name || !url) { alert("Thi·∫øu t√™n ho·∫∑c link!"); return; }
        
        fullPlaylist.push({ name: name, artist: "My Upload", src: url, isDefault: false });
        savePlaylistData();
        
        document.getElementById('new-song-name').value = '';
        document.getElementById('new-song-url').value = '';
        loadSong(fullPlaylist.length - 1, true);
    }

    function deleteSong(index, event) {
        event.stopPropagation();
        if(confirm(`X√≥a b√†i "${fullPlaylist[index].name}"?`)) {
            if(index === currentIdx) { audio.pause(); currentIdx = 0; }
            else if (index < currentIdx) currentIdx--;

            fullPlaylist.splice(index, 1);
            savePlaylistData();
            loadSong(currentIdx, false);
        }
    }

    function resetPlayer() {
        if(confirm("Vi·ªác n√†y s·∫Ω x√≥a h·∫øt danh s√°ch nh·∫°c c≈© ƒë·ªÉ n·∫°p l·∫°i danh s√°ch m·ªõi ·ªïn ƒë·ªãnh h∆°n. ƒê·ªìng √Ω?")) {
            localStorage.removeItem('my_full_playlist');
            location.reload();
        }
    }

    audio.addEventListener('play', () => updatePlayState(true));
    audio.addEventListener('pause', () => updatePlayState(false));
    
    // T·ª± ƒë·ªông b·ªè qua b√†i l·ªói
    audio.addEventListener('error', (e) => {
        console.error("Link h·ªèng:", audio.src);
        // ƒê√°nh d·∫•u b√†i l·ªói tr√™n giao di·ªán
        const items = document.querySelectorAll('.song-item');
        if(items[currentIdx]) items[currentIdx].classList.add('error');
        
        // Chuy·ªÉn b√†i sau 1s
        setTimeout(() => {
           nextSong();
        }, 1000);
    });

    function updatePlayState(isPlaying) {
        if(isPlaying) {
            playIcon.className = "fas fa-pause";
            vinyl.classList.add('playing');
            playBtn.style.background = "#00b894";
        } else {
            playIcon.className = "fas fa-play";
            vinyl.classList.remove('playing');
            playBtn.style.background = "";
        }
    }

    function toggleMediaSidebar() {
        const bar = document.getElementById('media-sidebar');
        bar.classList.toggle('minimized');
        document.getElementById('media-icon').style.display = bar.classList.contains('minimized') ? 'block' : 'none';
        document.getElementById('media-icon-close').style.display = bar.classList.contains('minimized') ? 'none' : 'block';
    }

    initMusicPlayer();
/* =======================================
       UPDATE: REPEAT & LOOP LOGIC
       ======================================= */
    
    // 0: T·∫Øt l·∫∑p, 1: L·∫∑p danh s√°ch (M·∫∑c ƒë·ªãnh), 2: L·∫∑p 1 b√†i
    let repeatState = 1; 

    // H√†m chuy·ªÉn ƒë·ªïi ch·∫ø ƒë·ªô L·∫∑p
    function toggleRepeat() {
        const btn = document.getElementById('btn-repeat');
        repeatState++;
        
        if (repeatState > 2) repeatState = 0; // Quay v√≤ng v·ªÅ 0

        // Reset class
        btn.className = 'ctrl-btn repeat-btn';

        if (repeatState === 0) {
            // T·∫Øt l·∫∑p
            btn.style.opacity = '0.3';
            showToast('ƒê√£ t·∫Øt l·∫∑p l·∫°i');
        } 
        else if (repeatState === 1) {
            // L·∫∑p danh s√°ch (All)
            btn.classList.add('repeat-all');
            btn.style.opacity = '1';
            showToast('Ch·∫ø ƒë·ªô: L·∫∑p to√†n b·ªô danh s√°ch');
        } 
        else if (repeatState === 2) {
            // L·∫∑p 1 b√†i (One)
            btn.classList.add('repeat-one');
            btn.style.opacity = '1';
            showToast('Ch·∫ø ƒë·ªô: L·∫∑p l·∫°i 1 b√†i n√†y');
        }
    }

    // Logic x·ª≠ l√Ω khi b√†i h√°t k·∫øt th√∫c (QUAN TR·ªåNG)
    audio.onended = function() {
        if (repeatState === 2) {
            // L·∫∑p 1 b√†i: Tua l·∫°i t·ª´ ƒë·∫ßu v√† ph√°t ti·∫øp
            audio.currentTime = 0;
            audio.play();
        } 
        else if (repeatState === 1) {
            // L·∫∑p danh s√°ch: T·ª± chuy·ªÉn b√†i ti·∫øp theo (Code c≈© ƒë√£ c√≥ logic quay v√≤ng)
            nextSong();
        } 
        else {
            // Kh√¥ng l·∫∑p: N·∫øu l√† b√†i cu·ªëi th√¨ d·ª´ng, ch∆∞a cu·ªëi th√¨ qua b√†i
            if (currentIdx < fullPlaylist.length - 1) {
                nextSong();
            } else {
                updatePlayState(false); // D·ª´ng l·∫°i
                showToast('ƒê√£ ph√°t h·∫øt danh s√°ch nh·∫°c');
            }
        }
    };

    // H√†m Next Song (C·∫≠p nh·∫≠t ƒë·ªÉ h·ªó tr·ª£ logic "Kh√¥ng l·∫∑p")
    function nextSong() { 
        // N·∫øu ƒëang t·∫Øt l·∫∑p (State 0) v√† ƒëang ·ªü b√†i cu·ªëi -> Quay v·ªÅ b√†i 1 nh∆∞ng KH√îNG ph√°t
        let autoPlay = true;
        if(repeatState === 0 && currentIdx === fullPlaylist.length - 1) {
            autoPlay = false;
        }
        
        loadSong(currentIdx + 1, autoPlay); 
    }

    // Bonus: H√†m tr·ªôn b√†i (Shuffle) ƒë∆°n gi·∫£n
    function shufflePlaylist() {
        if(confirm('B·∫°n c√≥ mu·ªën x√°o tr·ªôn danh s√°ch ph√°t kh√¥ng?')) {
            // Thu·∫≠t to√°n x√°o tr·ªôn Fisher-Yates
            for (let i = fullPlaylist.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [fullPlaylist[i], fullPlaylist[j]] = [fullPlaylist[j], fullPlaylist[i]];
            }
            // L∆∞u l·∫°i v√† render
            savePlaylistData();
            currentIdx = 0; // Reset v·ªÅ b√†i ƒë·∫ßu ti√™n c·ªßa list m·ªõi
            loadSong(0, true);
            showToast('ƒê√£ x√°o tr·ªôn danh s√°ch!');
        }
    }
</script>
<style>
    /* --- CSS FIX L·ªñI VIDEO (FINAL) --- */
    
    body {
        background: #000 !important; /* N·ªÅn g·ªëc m√†u ƒëen */
    }

    #bg-video-layer {
        position: fixed; top: 0; left: 0;
        width: 100vw; height: 100vh;
        object-fit: cover;
        z-index: -999;
        opacity: 0; /* M·∫∑c ƒë·ªãnh ·∫©n */
        transition: opacity 1.5s ease; /* Hi·ªán t·ª´ t·ª´ trong 1.5 gi√¢y */
        background: #000; /* Quan tr·ªçng: M√†u ƒëen khi ch·ªù video */
    }
    
    /* Ch·ªâ khi c√≥ class 'active' v√† 'loaded' m·ªõi hi·ªán */
    #bg-video-layer.active { opacity: 1; }

    /* L·ªõp ph·ªß t·ªëi ƒë·ªÉ video kh√¥ng l√†m l√≥a m·∫Øt */
    .video-overlay {
        position: fixed; top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.4); 
        z-index: -998;
        pointer-events: none;
    }

    /* 2. L·ªõp ph·ªß t·ªëi (ƒë·ªÉ ƒë·ªçc ch·ªØ r√µ h∆°n) */
    .video-overlay {
        position: fixed; top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.4); 
        z-index: -998;
        pointer-events: none;
        display: none;
    }
    #bg-video-layer.active + .video-overlay { display: block; }

    /* 3. L√ÄM TRONG SU·ªêT GIAO DI·ªÜN (ƒê·ªÉ nh√¨n th·∫•y video) */
    body {
        background: transparent !important; /* X√≥a m√†u n·ªÅn web */
    }

    /* 2. SHOP MODAL (C·ª≠a s·ªï c·ª≠a h√†ng) */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); z-index: 2000;
        display: none; align-items: center; justify-content: center;
        backdrop-filter: blur(5px);
        padding: 20px; /* C√°ch l·ªÅ ƒë·ªÉ kh√¥ng b·ªã d√≠nh s√°t m√†n h√¨nh */
    }
    .modal-overlay.open { display: flex; animation: fadeIn 0.3s; }

    .shop-box {
        width: 900px; 
        max-width: 100%; 
        max-height: 90vh; /* Quan tr·ªçng: Gi·ªõi h·∫°n chi·ªÅu cao b·∫±ng 90% m√†n h√¨nh */
        background: #1e1e2e; border-radius: 16px;
        border: 1px solid rgba(255,255,255,0.1);
        display: flex; flex-direction: column; overflow: hidden;
        box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }

    .shop-header {
        padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.1);
        display: flex; justify-content: space-between; align-items: center;
        background: rgba(255,255,255,0.05); flex-shrink: 0; /* Kh√¥ng b·ªã co l·∫°i */
    }
    .shop-title { font-size: 18px; font-weight: bold; color: white; display: flex; align-items: center; gap: 10px; }
    .user-balance { 
        background: linear-gradient(135deg, #00b894, #00cec9); 
        padding: 5px 15px; border-radius: 20px; color: white; font-weight: bold; font-size: 13px;
        box-shadow: 0 0 10px rgba(0, 184, 148, 0.4);
    }

    /* Ph·∫ßn n·ªôi dung cu·ªôn ƒë∆∞·ª£c */
    .shop-content { 
        flex: 1; 
        overflow-y: auto; /* Cho ph√©p cu·ªôn d·ªçc */
        padding: 20px; 
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
        gap: 15px;
    }

    /* T√πy ch·ªânh thanh cu·ªôn cho ƒë·∫πp */
    .shop-content::-webkit-scrollbar { width: 8px; }
    .shop-content::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
    .shop-content::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 4px; }
    .shop-content::-webkit-scrollbar-thumb:hover { background: #fff; }

    /* ITEM CARD */
    .shop-item {
        background: rgba(255,255,255,0.05); border-radius: 12px; overflow: hidden;
        border: 1px solid rgba(255,255,255,0.05); transition: 0.2s; position: relative;
        display: flex; flex-direction: column;
    }
    .shop-item:hover { transform: translateY(-3px); border-color: var(--accent); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    
    .item-preview { 
        height: 100px; background: #000; position: relative; overflow: hidden; flex-shrink: 0;
    }
    .item-preview img, .item-preview video { width: 100%; height: 100%; object-fit: cover; }
    
    .item-info { padding: 10px; text-align: center; color: white; display: flex; flex-direction: column; flex: 1; justify-content: space-between; }
    .item-name { font-size: 13px; font-weight: bold; margin-bottom: 5px; }
    .item-price { font-size: 11px; color: #fab1a0; margin-bottom: 8px; }

    .action-btn {
        width: 100%; padding: 6px; border: none; border-radius: 6px;
        font-weight: bold; cursor: pointer; font-size: 11px; transition: 0.2s;
    }
    .btn-buy { background: var(--accent); color: white; }
    .btn-buy:hover { opacity: 0.9; transform: scale(1.05); }
    .btn-equip { background: #00b894; color: white; }
    .btn-equipped { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.5); cursor: default; }
    .btn-locked { background: #636e72; color: #b2bec3; cursor: not-allowed; }

    .close-shop { cursor: pointer; color: white; font-size: 20px; opacity: 0.7; transition: 0.2s; }
    .close-shop:hover { opacity: 1; transform: rotate(90deg); color: #ff7675; }
    /* --- CSS SHOP FIX (D√°n v√†o ph·∫ßn Style) --- */
.shop-item {
    background: rgba(30, 30, 46, 0.8);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    transition: 0.3s;
    position: relative;
}
.shop-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.3);
    border-color: var(--accent);
}

/* Ph·∫ßn h√¨nh ·∫£nh xem tr∆∞·ªõc (Preview) */
.item-preview {
    height: 110px;
    width: 100%;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

/* Icon ƒë·∫°i di·ªán ·ªü gi·ªØa h√¨nh */
.preview-icon {
    font-size: 32px;
    color: white;
    z-index: 2;
    text-shadow: 0 2px 10px rgba(0,0,0,0.5);
}

/* Nh√£n gi√° ti·ªÅn */
.price-tag {
    position: absolute;
    top: 8px; right: 8px;
    background: rgba(0,0,0,0.6);
    color: #fab1a0;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: bold;
    backdrop-filter: blur(4px);
    z-index: 3;
}

/* N√∫t b·∫•m mua/d√πng */
.action-btn {
    margin-top: auto;
    width: 100%;
    padding: 8px;
    border: none;
    font-weight: bold;
    cursor: pointer;
    font-size: 11px;
    text-transform: uppercase;
    transition: 0.2s;
}
.btn-buy { background: #2d3436; color: white; border-top: 2px solid var(--accent); }
.btn-buy:hover { background: var(--accent); }
.btn-equip { background: var(--success); color: white; }
.btn-equipped { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.5); cursor: default; }

</style>

<video id="bg-video-layer" loop muted autoplay></video>

<div class="modal-overlay" id="shop-modal">
    <div class="shop-box">
        <div class="shop-header">
            <div class="shop-title">
                <i class="fas fa-shopping-cart"></i> 
                <span>C·ª≠a H√†ng XP</span>
            </div>
            <div style="display:flex; gap:15px; align-items:center">
                <div class="user-balance" id="shop-balance">0 XP</div>
                <i class="fas fa-times close-shop" onclick="toggleShop()"></i>
            </div>
        </div>
        
        <div class="shop-tabs">
    <button class="tab-btn active" onclick="switchShopTab('theme')">M√†u Giao Di·ªán</button>
</div>

        <div class="shop-content" id="shop-grid">
            </div>
    </div>
</div>

<script>
/* =======================================
       SHOP LOGIC: SOUND PACKS UPDATE
       ======================================= */

    const SHOP_DATABASE = [
        // --- THEMES (M√ÄU GIAO DI·ªÜN) ---
        { 
            id: 'theme_purple', type: 'theme', name: 'T√≠m M·ªông M∆°', price: 0, 
            color: '#6c5ce7', icon: 'fa-palette',
            colors: { '--accent': '#6c5ce7', '--accent-hover': '#a29bfe', '--success': '#00b894' } 
        },
        { 
            id: 'theme_hacker', type: 'theme', name: 'Ma Tr·∫≠n Xanh', price: 0, 
            color: '#00b894', icon: 'fa-terminal',
            colors: { '--accent': '#00b894', '--accent-hover': '#55efc4', '--success': '#00cec9' } 
        },
        { 
            id: 'theme_sunset', type: 'theme', name: 'Ho√†ng H√¥n', price: 0, 
            color: '#e17055', icon: 'fa-sun',
            colors: { '--accent': '#e17055', '--accent-hover': '#fab1a0', '--success': '#fdcb6e' } 
        },
        { 
            id: 'theme_dark', type: 'theme', name: 'B√≥ng ƒê√™m', price: 0, 
            color: '#2d3436', icon: 'fa-moon',
            colors: { '--accent': '#636e72', '--accent-hover': '#b2bec3', '--success': '#2d3436' } 
        },
        
        // --- MUSIC PACKS (G√ìI √ÇM THANH - ƒê√É N√ÇNG C·∫§P) ---
        {
            id: 'pack_default', type: 'music', name: 'M·∫∑c ƒê·ªãnh (Cozy)', price: 0,
            color: '#fab1a0', icon: 'fa-home',
            desc: 'M∆∞a, Qu√°n Cafe, L·ª≠a tr·∫°i',
            sources: {
                rain: 'https://actions.google.com/sounds/v1/weather/rain_heavy_loud.ogg',
                cafe: 'https://actions.google.com/sounds/v1/ambiences/coffee_shop.ogg',
                fire: 'https://actions.google.com/sounds/v1/ambiences/fire.ogg'
            },
            icons: ['fa-cloud-rain', 'fa-coffee', 'fa-fire']
        },
        {
            id: 'pack_nature', type: 'music', name: 'Thi√™n Nhi√™n (Zen)', price: 0,
            color: '#55efc4', icon: 'fa-tree',
            desc: 'R·ª´ng c√¢y, Su·ªëi ch·∫£y, D·∫ø ƒë√™m',
            sources: {
                rain: 'https://actions.google.com/sounds/v1/animals/birds_forest_morning.ogg', // Chim h√≥t (Thay cho m∆∞a)
                cafe: 'https://actions.google.com/sounds/v1/water/river_flow.ogg',             // Su·ªëi ch·∫£y (Thay cho Cafe)
                fire: 'https://actions.google.com/sounds/v1/animals/crickets.ogg'              // D·∫ø k√™u (Thay cho l·ª≠a)
            },
            icons: ['fa-dove', 'fa-water', 'fa-moon']
        },
        {
            id: 'pack_focus', type: 'music', name: 'Si√™u T·∫≠p Trung (Deep Work)', price: 0,
            color: '#74b9ff', icon: 'fa-brain',
            desc: 'Nhi·ªÖu tr·∫Øng, G√µ ph√≠m, V≈© tr·ª•',
            sources: {
                rain: 'https://actions.google.com/sounds/v1/science/white_noise.ogg',     // White Noise
                cafe: 'https://actions.google.com/sounds/v1/office/typing.ogg',           // G√µ ph√≠m
                fire: 'https://actions.google.com/sounds/v1/science/station_hum_long.ogg' // Ti·∫øng tr·∫°m v≈© tr·ª•
            },
            icons: ['fa-wind', 'fa-keyboard', 'fa-rocket']
        }
    ];

    // C√ÅC BI·∫æN QU·∫¢N L√ù
    let equippedTheme = 'theme_purple';
    let currentShopTab = 'theme'; // M·∫∑c ƒë·ªãnh v√†o tab Theme lu√¥n

    // KH·ªûI CH·∫†Y
    window.addEventListener('load', () => {
        loadSettings();
        injectShopButton();
        
        // √Åp d·ª•ng Theme
        applyTheme(equippedTheme);
        
        // ·∫®n l·ªõp video n·ªÅn (V√¨ ƒë√£ x√≥a t√≠nh nƒÉng h√¨nh n·ªÅn)
        const videoLayer = document.getElementById('bg-video-layer');
        if(videoLayer) {
            videoLayer.style.display = 'none';
            videoLayer.src = ''; // Ng·∫Øt t·∫£i video ƒë·ªÉ nh·∫π m√°y
        }
    });

    // 1. RENDER GIAO DI·ªÜN
    function renderShopItems() {
        const grid = document.getElementById('shop-grid');
        grid.innerHTML = '';
        
        const items = SHOP_DATABASE.filter(i => i.type === currentShopTab);

        if(items.length === 0) {
            grid.innerHTML = '<div style="color:white; opacity:0.5; width:100%; text-align:center; padding:20px;">ƒêang c·∫≠p nh·∫≠t th√™m v·∫≠t ph·∫©m...</div>';
            return;
        }

        items.forEach(item => {
            const isEquipped = equippedTheme === item.id; // Ch·ªâ so s√°nh Theme
            
            // N√∫t b·∫•m
            let btnHtml = '';
            if (isEquipped && item.type === 'theme') {
                btnHtml = `<button class="action-btn btn-equipped"><i class="fas fa-check"></i> ƒêANG D√ôNG</button>`;
            } else {
                btnHtml = `<button class="action-btn btn-equip" style="background:var(--success)" onclick="equipItem('${item.id}')">
                    S·ª¨ D·ª§NG
                </button>`;
            }

            // Hi·ªÉn th·ªã Preview (M√†u s·∫Øc ho·∫∑c Icon nh·∫°c)
            let previewContent = '';
            if (item.type === 'theme') {
                previewContent = `<div style="width:100%;height:100%;background:${item.color}"></div>`;
            } else {
                previewContent = `<div style="width:100%;height:100%;background:${item.color};display:flex;align-items:center;justify-content:center;font-size:40px;opacity:0.8"><i class="fas ${item.icon}"></i></div>`;
            }

            const card = document.createElement('div');
            card.className = 'shop-item';
            card.innerHTML = `
                <div class="item-preview">
                    <div class="price-tag" style="background:#00b894; color:white">FREE</div>
                    ${previewContent}
                    ${item.type === 'theme' ? `<i class="fas ${item.icon} preview-icon"></i>` : ''}
                </div>
                <div class="item-info">
                    <div class="item-name">${item.name}</div>
                    ${btnHtml}
                </div>
            `;
            grid.appendChild(card);
        });
    }

    // 2. CH·ª®C NƒÇNG S·ª¨ D·ª§NG
    function equipItem(id) {
        const item = SHOP_DATABASE.find(i => i.id === id);
        if(!item) return;

        if(item.type === 'theme') {
            equippedTheme = id;
            applyTheme(id);
            showToast(`ƒê√£ √°p d·ª•ng giao di·ªán: ${item.name}`);
        } 
        else if (item.type === 'music') {
            equippedMusic = id;
            applySoundPack(id);
            showToast(`ƒê√£ t·∫£i g√≥i √¢m thanh: ${item.name}`);
        }

        saveSettings();
        renderShopItems();
        if(typeof AUDIO_SYS !== 'undefined') AUDIO_SYS.sfx.success();
    }

    // H√ÄM M·ªöI: √ÅP D·ª§NG G√ìI √ÇM THANH
    function applySoundPack(id) {
        const pack = SHOP_DATABASE.find(i => i.id === id);
        if(!pack || !pack.sources) return;

        // 1. T·∫Øt nh·∫°c ƒëang ph√°t ƒë·ªÉ tr√°nh l·ªói
        document.querySelectorAll('.sound-board audio').forEach(a => {
            a.pause();
            a.currentTime = 0;
        });
        document.querySelectorAll('.sound-board .sound-btn').forEach(b => b.classList.remove('active'));

        // 2. Thay ƒë·ªïi ngu·ªìn nh·∫°c (Source)
        document.getElementById('audio-rain').src = pack.sources.rain;
        document.getElementById('audio-cafe').src = pack.sources.cafe;
        document.getElementById('audio-fire').src = pack.sources.fire;

        // 3. Thay ƒë·ªïi Icon tr√™n n√∫t b·∫•m (Cho chuy√™n nghi·ªáp)
        const btns = document.querySelectorAll('.sound-board .sound-btn');
        if(btns.length >= 3 && pack.icons) {
            // N√∫t 1
            btns[0].innerHTML = `<i class="fas ${pack.icons[0]}"></i>`;
            btns[0].onclick = function() { toggleAmbience('rain', this); }; // Re-bind ƒë·ªÉ ƒë·∫£m b·∫£o ƒë√∫ng ID
            
            // N√∫t 2
            btns[1].innerHTML = `<i class="fas ${pack.icons[1]}"></i>`;
            btns[1].onclick = function() { toggleAmbience('cafe', this); };

            // N√∫t 3
            btns[2].innerHTML = `<i class="fas ${pack.icons[2]}"></i>`;
            btns[2].onclick = function() { toggleAmbience('fire', this); };
        }
    }

    // C·∫≠p nh·∫≠t h√†m Load Settings ƒë·ªÉ nh·ªõ g√≥i nh·∫°c
    function loadSettings() {
        const data = JSON.parse(localStorage.getItem('LifeOS_Settings_V4'));
        if(data) {
            equippedTheme = data.equippedTheme || 'theme_purple';
            equippedMusic = data.equippedMusic || 'pack_default'; // Load g√≥i nh·∫°c
        }
    }

    // C·∫≠p nh·∫≠t h√†m Save Settings
    function saveSettings() {
        localStorage.setItem('LifeOS_Settings_V4', JSON.stringify({ 
            equippedTheme, equippedMusic 
        }));
    }

    // C·∫≠p nh·∫≠t window.onload ƒë·ªÉ √°p d·ª•ng g√≥i nh·∫°c khi v√†o web
    window.addEventListener('load', () => {
        loadSettings();
        injectShopButton();
        
        applyTheme(equippedTheme);
        applySoundPack(equippedMusic); // √Åp d·ª•ng g√≥i nh·∫°c ƒë√£ l∆∞u
        
        // ·∫®n l·ªõp video n·ªÅn c≈©
        const videoLayer = document.getElementById('bg-video-layer');
        if(videoLayer) videoLayer.style.display = 'none';
    });

    // 3. H√ÄM √ÅP D·ª§NG THEME
    function applyTheme(id) {
        const item = SHOP_DATABASE.find(i => i.id === id);
        if(item && item.colors) {
            const root = document.documentElement;
            for (const [key, value] of Object.entries(item.colors)) {
                root.style.setProperty(key, value);
            }
        }
    }

    // 4. L∆ØU & T·∫¢I DATA
    function saveSettings() {
        localStorage.setItem('LifeOS_Settings_V4', JSON.stringify({ 
            equippedTheme 
        }));
    }

    function loadSettings() {
        const data = JSON.parse(localStorage.getItem('LifeOS_Settings_V4'));
        if(data) {
            equippedTheme = data.equippedTheme || 'theme_purple';
        }
    }

    // C√ÅC H√ÄM UI PH·ª§ TR·ª¢
    function toggleShop() {
        const modal = document.getElementById('shop-modal');
        modal.classList.toggle('open');
        if(modal.classList.contains('open')) renderShopItems();
    }

    function switchShopTab(tab) {
        currentShopTab = tab;
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
            if(btn.onclick && btn.onclick.toString().includes(tab)) btn.classList.add('active');
        });
        renderShopItems();
    }

    function injectShopButton() {
        const toolWidgets = document.querySelectorAll('.widget-title');
        let toolsWidget = null;
        toolWidgets.forEach(w => { if(w.innerText.toLowerCase().includes('c√¥ng c·ª•')) toolsWidget = w.parentElement; });

        if(toolsWidget && !document.getElementById('btn-open-shop')) {
            const btn = document.createElement('button');
            btn.id = 'btn-open-shop';
            btn.className = 'sound-btn';
            btn.style.width = '100%';
            btn.style.textAlign = 'left';
            btn.style.background = 'linear-gradient(90deg, #6c5ce7, #a29bfe)';
            btn.innerHTML = '<i class="fas fa-shopping-cart"></i> <b>C·ª≠a H√†ng (Theme)</b>';
            btn.onclick = toggleShop;
            const firstBtn = toolsWidget.querySelector('button');
            if(firstBtn) toolsWidget.insertBefore(btn, firstBtn);
        }
    }
    /* =======================================
       T√çNH NƒÇNG TUA NH·∫†C (SEEKBAR)
       ======================================= */
    
    const seekBar = document.getElementById('seek-bar');
    const currTimeText = document.getElementById('curr-time');
    const totalDurText = document.getElementById('total-dur');
    let isDragging = false; // Bi·∫øn ki·ªÉm tra xem ng∆∞·ªùi d√πng c√≥ ƒëang gi·ªØ chu·ªôt kh√¥ng

    // 1. C·∫≠p nh·∫≠t thanh tr∆∞·ª£t khi nh·∫°c ch·∫°y
    audio.addEventListener('timeupdate', () => {
        // Ch·ªâ c·∫≠p nh·∫≠t t·ª± ƒë·ªông n·∫øu ng∆∞·ªùi d√πng KH√îNG ƒëang k√©o chu·ªôt
        if(!isDragging && audio.duration) {
            // T√≠nh ph·∫ßn trƒÉm ƒë√£ ch·∫°y
            const progress = (audio.currentTime / audio.duration) * 100;
            seekBar.value = progress;
            
            // C·∫≠p nh·∫≠t s·ªë ph√∫t gi√¢y
            currTimeText.innerText = formatTime(audio.currentTime);
            totalDurText.innerText = formatTime(audio.duration);
        }
    });

    // 2. Khi t·∫£i b√†i h√°t xong -> Reset thanh tr∆∞·ª£t
    audio.addEventListener('loadedmetadata', () => {
        seekBar.value = 0;
        currTimeText.innerText = "0:00";
        totalDurText.innerText = formatTime(audio.duration);
    });

    // 3. H√†m x·ª≠ l√Ω khi ng∆∞·ªùi d√πng k√©o thanh tr∆∞·ª£t (Tua)
    function seekAudio() {
        const seekTo = audio.duration * (seekBar.value / 100);
        audio.currentTime = seekTo;
    }

    // S·ª± ki·ªán ƒë·ªÉ tr√°nh thanh tr∆∞·ª£t b·ªã gi·∫≠t khi ƒëang k√©o
    seekBar.addEventListener('mousedown', () => isDragging = true);
    seekBar.addEventListener('touchstart', () => isDragging = true);
    
    seekBar.addEventListener('change', () => {
        isDragging = false;
        seekAudio(); // Tua l·∫ßn cu·ªëi khi th·∫£ chu·ªôt
    });
    seekBar.addEventListener('mouseup', () => isDragging = false);
    seekBar.addEventListener('touchend', () => isDragging = false);

    // 4. H√†m chuy·ªÉn ƒë·ªïi gi√¢y sang ph√∫t:gi√¢y (VD: 125s -> 2:05)
    function formatTime(seconds) {
        if(isNaN(seconds)) return "0:00";
        const m = Math.floor(seconds / 60);
        const s = Math.floor(seconds % 60);
        return `${m}:${s < 10 ? '0' : ''}${s}`;
    }
    /* =======================================
       PH·ª§C H·ªíI N√öT C·ª¨A H√ÄNG (D√°n v√†o cu·ªëi Script)
       ======================================= */

    // 1. H√†m t·∫°o n√∫t C·ª≠a H√†ng v√† ch√®n v√†o Widget C√¥ng c·ª•
    function injectShopButton() {
        // T√¨m Widget c√≥ ti√™u ƒë·ªÅ ch·ª©a ch·ªØ "C√¥ng c·ª•"
        const toolWidgets = document.querySelectorAll('.widget-title');
        let toolsWidget = null;
        
        toolWidgets.forEach(w => { 
            if(w.innerText.toLowerCase().includes('c√¥ng c·ª•')) {
                toolsWidget = w.parentElement; 
            }
        });

        // N·∫øu t√¨m th·∫•y Widget v√† ch∆∞a c√≥ n√∫t Shop th√¨ t·∫°o m·ªõi
        if(toolsWidget && !document.getElementById('btn-open-shop')) {
            const btn = document.createElement('button');
            btn.id = 'btn-open-shop';
            btn.className = 'sound-btn'; // D√πng class gi·ªëng c√°c n√∫t kh√°c
            btn.style.width = '100%';
            btn.style.textAlign = 'left';
            btn.style.marginBottom = '5px';
            btn.style.background = 'linear-gradient(90deg, #6c5ce7, #a29bfe)'; // M√†u t√≠m n·ªïi b·∫≠t
            btn.style.border = 'none';
            btn.style.color = 'white';
            btn.style.fontWeight = 'bold';
            
            btn.innerHTML = '<i class="fas fa-shopping-cart"></i> <b>C·ª≠a H√†ng (Theme/Nh·∫°c)</b>';
            
            // G√°n s·ª± ki·ªán m·ªü shop
            btn.onclick = toggleShop;
            
            // Ch√®n n√∫t n√†y l√™n ƒë·∫ßu ti√™n trong widget C√¥ng c·ª•
            const firstBtn = toolsWidget.querySelector('button');
            if(firstBtn) {
                toolsWidget.insertBefore(btn, firstBtn);
            } else {
                toolsWidget.appendChild(btn);
            }
        }
    }

    // 2. Ch·∫°y h√†m n√†y ngay l·∫≠p t·ª©c ƒë·ªÉ hi·ªán n√∫t
    injectShopButton();

    // 3. ƒê·∫£m b·∫£o h√†m n√†y lu√¥n ch·∫°y khi web t·∫£i xong
    window.addEventListener('load', () => {
        // Load l·∫°i setting c≈©
        if(typeof loadSettings === 'function') loadSettings();
        
        // T·∫°o n√∫t
        injectShopButton();
        
        // √Åp d·ª•ng theme/nh·∫°c ƒë√£ l∆∞u
        if(typeof applyTheme === 'function' && typeof equippedTheme !== 'undefined') {
            applyTheme(equippedTheme);
        }
        if(typeof applySoundPack === 'function' && typeof equippedMusic !== 'undefined') {
            applySoundPack(equippedMusic);
        }
    });
    /* =======================================
       FIX L·ªñI: LOGIC ƒê·ªîI G√ìI √ÇM THANH (GHI ƒê√à)
       ======================================= */

    // 1. H√†m x·ª≠ l√Ω khi b·∫•m n√∫t "S·ª¨ D·ª§NG"
    window.equipItem = function(id) {
        // T√¨m v·∫≠t ph·∫©m trong kho
        const item = SHOP_DATABASE.find(i => i.id === id);
        if(!item) return;

        if(item.type === 'theme') {
            // X·ª≠ l√Ω thay ƒë·ªïi M√†u s·∫Øc
            equippedTheme = id;
            applyTheme(id);
            showToast(`ƒê√£ ƒë·ªïi giao di·ªán: ${item.name}`);
        } 
        else if (item.type === 'music') {
            // X·ª≠ l√Ω thay ƒë·ªïi √Çm thanh
            equippedMusic = id;
            applySoundPack(id);
            showToast(`ƒê√£ n·∫°p g√≥i √¢m thanh: ${item.name}`);
        }

        // L∆∞u l·∫°i v√† v·∫Ω l·∫°i giao di·ªán shop
        saveSettings();
        renderShopItems();
        
        // Hi·ªáu ·ª©ng √¢m thanh x√°c nh·∫≠n
        if(typeof AUDIO_SYS !== 'undefined') AUDIO_SYS.sfx.success();
    };

    // 2. H√†m th·ª±c thi vi·ªác thay ƒë·ªïi ngu·ªìn nh·∫°c (Core Logic)
    window.applySoundPack = function(id) {
        const pack = SHOP_DATABASE.find(i => i.id === id);
        if(!pack || !pack.sources) return;

        console.log("ƒêang n·∫°p g√≥i nh·∫°c:", pack.name);

        // B1: T·∫Øt nh·∫°c c≈© ƒëang ph√°t (n·∫øu c√≥)
        const allAudio = document.querySelectorAll('.sound-board audio');
        allAudio.forEach(a => {
            a.pause();
            a.currentTime = 0;
        });
        
        // B·ªè active c√°c n√∫t b·∫•m
        document.querySelectorAll('.sound-board .sound-btn').forEach(b => b.classList.remove('active'));

        // B2: Thay "ru·ªôt" (Link nh·∫°c) cho c√°c th·∫ª Audio c√≥ s·∫µn
        // L∆∞u √Ω: ID audio-rain, audio-cafe, audio-fire l√† c·ªë ƒë·ªãnh trong HTML
        const aRain = document.getElementById('audio-rain');
        const aCafe = document.getElementById('audio-cafe');
        const aFire = document.getElementById('audio-fire');

        if(aRain) aRain.src = pack.sources.rain;
        if(aCafe) aCafe.src = pack.sources.cafe;
        if(aFire) aFire.src = pack.sources.fire;

        // B3: Thay ƒë·ªïi Icon tr√™n thanh c√¥ng c·ª• b√™n ph·∫£i (Sidebar)
        const btns = document.querySelectorAll('.sound-board .sound-btn');
        if(btns.length >= 3 && pack.icons) {
            // C·∫≠p nh·∫≠t n√∫t 1
            btns[0].innerHTML = `<i class="fas ${pack.icons[0]}"></i>`;
            btns[0].setAttribute('onclick', `toggleAmbience('rain', this)`); // Reset s·ª± ki·ªán
            
            // C·∫≠p nh·∫≠t n√∫t 2
            btns[1].innerHTML = `<i class="fas ${pack.icons[1]}"></i>`;
            btns[1].setAttribute('onclick', `toggleAmbience('cafe', this)`);

            // C·∫≠p nh·∫≠t n√∫t 3
            btns[2].innerHTML = `<i class="fas ${pack.icons[2]}"></i>`;
            btns[2].setAttribute('onclick', `toggleAmbience('fire', this)`);
        }

        // B4: Ph√°t th·ª≠ 1 ƒëo·∫°n ng·∫Øn (Preview) ƒë·ªÉ ng∆∞·ªùi d√πng bi·∫øt ƒë√£ ƒë·ªïi
        if(aRain) {
            aRain.volume = 0.5;
            aRain.play().then(() => {
                // T·ª± t·∫Øt sau 3 gi√¢y
                setTimeout(() => { 
                    aRain.pause(); 
                    aRain.currentTime = 0; 
                }, 3000);
            }).catch(e => console.log("Tr√¨nh duy·ªát ch·∫∑n ph√°t th·ª≠: ", e));
        }
    };

    // 3. C·∫≠p nh·∫≠t l·∫°i h√†m Load ƒë·ªÉ nh·ªõ g√≥i nh·∫°c khi F5
    window.loadSettings = function() {
        const data = JSON.parse(localStorage.getItem('LifeOS_Settings_V4'));
        if(data) {
            equippedTheme = data.equippedTheme || 'theme_purple';
            equippedMusic = data.equippedMusic || 'pack_default';
        }
        // Bi·∫øn to√†n c·ª•c ƒë·ªÉ qu·∫£n l√Ω tab
        window.equippedTheme = equippedTheme;
        window.equippedMusic = equippedMusic;
    };
    
    // Ch·∫°y l·∫°i logic n·∫°p 1 l·∫ßn ngay sau khi d√°n code
    loadSettings();
    applySoundPack(equippedMusic);

</script>
<style>
    .sidebar {
        /* 1. M·ªü kh√≥a chu·ªôt ƒë·ªÉ cu·ªôn ƒë∆∞·ª£c */
        pointer-events: auto !important;
        
        /* 2. Cho ph√©p cu·ªôn d·ªçc khi n·ªôi dung qu√° d√†i */
        overflow-y: auto !important;
        
        /* 3. Tinh ch·ªânh chi·ªÅu cao ƒë·ªÉ kh√¥ng b·ªã k·∫πt */
        bottom: 20px !important;
        max-height: calc(100vh - 40px) !important;
        
        /* 4. Th√™m ch√∫t kho·∫£ng tr·ªëng b√™n ph·∫£i ƒë·ªÉ kh√¥ng b·ªã s√°t l·ªÅ */
        padding-right: 5px;
    }

    /* L√†m ƒë·∫πp thanh cu·ªôn c·ªßa Sidebar (Nh·ªè g·ªçn, tinh t·∫ø) */
    .sidebar::-webkit-scrollbar {
        width: 4px;
    }
    .sidebar::-webkit-scrollbar-track {
        background: transparent;
    }
    .sidebar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
    }
    .sidebar::-webkit-scrollbar-thumb:hover {
        background: var(--accent);
    }
</style>
<style>
    /* --- FIX L·ªñI HI·ªÇN TH·ªä MOBILE (V3.1 FIXED) --- */
    @media screen and (max-width: 1024px) { /* TƒÉng ph·∫°m vi ƒë·ªÉ b·∫Øt m·ªçi lo·∫°i ƒëi·ªán tho·∫°i */
        
        /* 1. √âp body d√πng to√†n b·ªô m√†n h√¨nh */
        body {
            padding: 0 !important;
            display: block !important;
            overflow-x: hidden !important; /* Ch·∫∑n k√©o ngang */
        }

        /* 2. √âp t·ªù gi·∫•y tr·∫Øng full m√†n h√¨nh v√† kh√¥ng b·ªã ng·∫Øt ngang */
        .planner {
            width: 100% !important;
            max-width: 100% !important;
            min-height: 100vh !important; /* Chi·ªÅu cao t·ªëi thi·ªÉu b·∫±ng m√†n h√¨nh */
            margin: 0 !important;
            border-radius: 0 !important; /* B·ªè bo g√≥c ƒë·ªÉ full m√†n */
            box-sizing: border-box !important;
            padding: 15px !important;
            display: flex !important;
            flex-direction: column !important;
        }

        /* 3. QUAN TR·ªåNG: Chuy·ªÉn 2 c·ªôt th√†nh h√†ng d·ªçc */
        /* L·ªói trong ·∫£nh l√† do d√≤ng n√†y ch∆∞a nh·∫≠n, gi·ªù th√™m !important ƒë·ªÉ b·∫Øt bu·ªôc */
        .main-grid {
            display: flex !important;
            flex-direction: column !important;
            gap: 30px !important;
        }

        /* ƒê·∫£m b·∫£o n·ªôi dung b√™n trong full chi·ªÅu r·ªông */
        .col {
            width: 100% !important;
        }

        /* 4. ƒê∆∞a Sidebar (C√¥ng c·ª•/Nh·∫°c) xu·ªëng d∆∞·ªõi c√πng */
        .sidebar, .sidebar-left {
            position: static !important; /* B·ªè ch·∫ø ƒë·ªô treo l∆° l·ª≠ng */
            width: 100% !important;
            margin-top: 20px !important;
            transform: none !important;
            padding-right: 0 !important;
            display: block !important;
        }

        /* ·∫®n c√°c n√∫t th·ª´a tr√™n mobile */
        .toggle-media-btn { display: none !important; }

        /* 5. Ch·ªânh l·∫°i k√≠ch th∆∞·ªõc ch·ªØ cho d·ªÖ ƒë·ªçc tr√™n ƒëi·ªán tho·∫°i */
        .brand h1 { font-size: 32px !important; }
        .stat-val { font-size: 16px !important; }
        
        /* Fix l·ªói nh·∫≠p li·ªáu b·ªã ph√≥ng to tr√™n iPhone */
        input, textarea { font-size: 16px !important; }
    }
</style>
</body>
<video id="bg-video-layer" loop muted autoplay playsinline></video>
<div class="video-overlay"></div>
<style>
    /* --- FIX L·ªñI M√ÄN H√åNH TR·∫ÆNG --- */
    body {
        /* ƒê·∫∑t l·∫°i m√†u n·ªÅn t·ªëi (thay v√¨ trong su·ªët ch·ªù video nh∆∞ tr∆∞·ªõc) */
        background-color: #15151e !important; 
        
        /* T·∫°o hi·ªáu ·ª©ng n·ªÅn gradient nh·∫π cho sang tr·ªçng */
        background-image: radial-gradient(circle at 50% 0%, #2d3436 0%, #15151e 100%) !important;
        
        /* ƒê·∫£m b·∫£o full m√†n h√¨nh */
        min-height: 100vh;
    }

    /* TƒÉng ƒë·ªô ƒë·∫≠m cho n·ªÅn c√°c Widget b√™n ph·∫£i ƒë·ªÉ ch·ªØ d·ªÖ ƒë·ªçc h∆°n */
    .sidebar .widget {
        background: rgba(30, 30, 46, 0.85) !important;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    /* Ch·ªânh l·∫°i m√†u ti√™u ƒë·ªÅ b√™n ph·∫£i cho r√µ h∆°n */
    .widget-title {
        color: #fff !important;
        text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    /* Style cho n√∫t Repeat */
.ctrl-btn.repeat-btn {
    position: relative;
    transition: all 0.3s;
}

/* Ch·∫ø ƒë·ªô L·∫∑p Danh S√°ch (M√†u xanh) */
.ctrl-btn.repeat-all {
    color: var(--success);
    opacity: 1;
    text-shadow: 0 0 10px rgba(0, 184, 148, 0.4);
}

/* Ch·∫ø ƒë·ªô L·∫∑p 1 B√†i (C√≥ s·ªë 1 nh·ªè) */
.ctrl-btn.repeat-one {
    color: var(--accent); /* M√†u t√≠m/h·ªìng ch·ªß ƒë·∫°o */
    opacity: 1;
    text-shadow: 0 0 10px var(--accent);
}
.ctrl-btn.repeat-one::after {
    content: '1';
    position: absolute;
    top: -2px;
    right: -4px;
    font-size: 8px;
    font-weight: 800;
    background: var(--bg-body); /* N·ªÅn tr√πng m√†u web */
    padding: 0 2px;
    border-radius: 4px;
}

</style>
<script>
    /* ======================================================
       B·∫¢N V√Å: LO·∫†I B·ªé SHOP NH·∫†C & FIX L·ªñI PH√ÅT TI·∫æNG
       ====================================================== */

    // 1. GHI ƒê√à KHO H√ÄNG (CH·ªà C√íN THEME)
    // Bi·∫øn n√†y s·∫Ω thay th·∫ø ho√†n to√†n bi·∫øn SHOP_DATABASE c≈©
    var SHOP_DATABASE = [
        { id: 'theme_purple', type: 'theme', name: 'T√≠m M·ªông M∆°', color: '#6c5ce7', icon: 'fa-palette', colors: {'--accent':'#6c5ce7', '--bg-body':'#15151e'} },
        { id: 'theme_green', type: 'theme', name: 'Xanh Hacker', color: '#00b894', icon: 'fa-terminal', colors: {'--accent':'#00b894', '--bg-body':'#000000'} },
        { id: 'theme_orange', type: 'theme', name: 'Ho√†ng H√¥n', color: '#e17055', icon: 'fa-sun', colors: {'--accent':'#e17055', '--bg-body':'#2d3436'} },
        { id: 'theme_dark', type: 'theme', name: 'B√≥ng ƒê√™m', color: '#2d3436', icon: 'fa-moon', colors: {'--accent':'#636e72', '--bg-body':'#1e1e2e'} }
    ];

    // 2. GHI ƒê√à H√ÄM V·∫º SHOP (·∫®N TAB NH·∫†C)
    window.renderShopItems = function() {
        const grid = document.getElementById('shop-grid');
        if(!grid) return;
        grid.innerHTML = '';
        
        // Lu√¥n render Theme, b·ªè qua tab nh·∫°c
        SHOP_DATABASE.forEach(item => {
            const isEquipped = (window.equippedTheme === item.id);
            let btnHtml = isEquipped 
                ? `<button class="action-btn btn-equipped"><i class="fas fa-check"></i> ƒêANG D√ôNG</button>`
                : `<button class="action-btn btn-equip" onclick="equipItem('${item.id}')">S·ª¨ D·ª§NG</button>`;

            grid.innerHTML += `
                <div class="shop-item">
                    <div class="item-preview">
                        <div style="width:100%;height:100%;background:${item.color}"></div>
                    </div>
                    <div class="item-info">
                        <div class="item-name">${item.name}</div>
                        ${btnHtml}
                    </div>
                </div>`;
        });
    };

    // 3. GHI ƒê√à H√ÄM MUA ƒê·ªí (CH·ªà X·ª¨ L√ù THEME)
    window.equipItem = function(id) {
        const item = SHOP_DATABASE.find(i => i.id === id);
        if(item) {
            window.equippedTheme = id;
            
            // √Åp d·ª•ng m√†u
            if(item.colors) {
                const r = document.documentElement;
                for(let k in item.colors) r.style.setProperty(k, item.colors[k]);
            }
            
            // L∆∞u l·∫°i
            localStorage.setItem('LifeOS_Settings_V5', JSON.stringify({ 
                equippedTheme: id 
            }));
            
            renderShopItems();
            
            // Th√¥ng b√°o
            const box = document.getElementById('toast-box');
            if(box) {
                box.innerHTML = `<div class="toast" style="background:#333;color:white;padding:10px;border-radius:20px;margin-top:10px">ƒê√£ ƒë·ªïi giao di·ªán: ${item.name}</div>`;
                setTimeout(() => box.innerHTML = '', 3000);
            }
        }
    };

    // 4. FIX L·ªñI B·∫¨T NH·∫†C (CLICK L√Ä CH·∫†Y)
    // T·ª± ƒë·ªông m·ªü kh√≥a tr√¨nh duy·ªát khi click l·∫ßn ƒë·∫ßu
    document.body.addEventListener('click', function() {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        if(ctx.state === 'suspended') ctx.resume();
    }, {once:true});

    // H√†m b·∫≠t t·∫Øt nh·∫°c m·ªõi (ƒë∆°n gi·∫£n h√≥a)
    window.toggleAmbience = function(type, btn) {
        const audio = document.getElementById('audio-' + type);
        if(!audio) return;

        if(audio.paused) {
            // T·∫Øt c√°c nh·∫°c kh√°c
            document.querySelectorAll('.sound-board audio').forEach(a => {
                if(a !== audio) { a.pause(); a.currentTime = 0; }
            });
            document.querySelectorAll('.sound-btn').forEach(b => b.classList.remove('active'));

            // B·∫≠t nh·∫°c n√†y
            audio.volume = 0.6;
            audio.play().then(() => {
                btn.classList.add('active');
            }).catch(e => {
                alert("B·∫°n c·∫ßn click v√†o trang web 1 l·∫ßn ƒë·ªÉ tr√¨nh duy·ªát cho ph√©p ph√°t nh·∫°c!");
            });
        } else {
            audio.pause();
            btn.classList.remove('active');
        }
    };

    // Ch·∫°y l·∫°i render 1 l·∫ßn ƒë·ªÉ c·∫≠p nh·∫≠t giao di·ªán ngay
    setTimeout(() => {
        if(typeof renderShopItems === 'function') renderShopItems();
    }, 500);

</script>
<style>
    /* --- FIX L·ªñI M√ÄU D·∫§U T√çCH (ƒê·ªíNG B·ªò V·ªöI THEME) --- */
    .check-box.checked {
        /* ƒê·ªïi t·ª´ var(--success) sang var(--accent) ƒë·ªÉ ƒÉn theo m√†u theme */
        background: var(--accent) !important;
        border-color: var(--accent) !important;
        box-shadow: 0 0 10px var(--accent); /* Th√™m ch√∫t hi·ªáu ·ª©ng ph√°t s√°ng cho ƒë·∫πp */
    }

    /* Ti·ªán th·ªÉ s·ª≠a lu√¥n m√†u thanh k√©o √¢m l∆∞·ª£ng cho ƒë·ªìng b·ªô */
    .mixer-slider::-webkit-slider-thumb {
        background: var(--accent) !important;
    }
</style>
<style>
    /* --- MATRIX GOD MODE CSS --- */
    
    /* 1. Khung l∆∞·ªõi 2x2 chu·∫©n ch·ªânh */
    #eisenhower-view {
        display: none; /* M·∫∑c ƒë·ªãnh ·∫©n */
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
        gap: 15px;
        height: 500px; /* Chi·ªÅu cao c·ªë ƒë·ªãnh ƒë·ªÉ scroll */
        animation: zoomIn 0.3s ease;
    }

    @keyframes zoomIn { from { opacity:0; transform:scale(0.95); } to { opacity:1; transform:scale(1); } }

    /* 2. Thi·∫øt k·∫ø t·ª´ng √¥ Ma tr·∫≠n (Quadrant) */
    .matrix-box {
        position: relative;
        border-radius: 12px;
        padding: 40px 10px 10px 10px; /* Ch·ª´a ch·ªó cho Header */
        display: flex;
        flex-direction: column;
        border: 1px solid rgba(255,255,255,0.05);
        box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
        transition: 0.3s;
        overflow: hidden;
    }
    
    .matrix-box:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }

    /* Header c·ªßa t·ª´ng √¥ (N·∫±m ch√¨m b√™n d∆∞·ªõi) */
    .matrix-header {
        position: absolute; top: 0; left: 0; right: 0;
        padding: 8px 15px;
        font-size: 11px; font-weight: 800; letter-spacing: 1px;
        text-transform: uppercase; color: rgba(255,255,255,0.8);
        display: flex; justify-content: space-between; align-items: center;
    }

    /* M√†u s·∫Øc ƒë·ªãnh danh cho 4 √¥ */
    .q1 { background: rgba(255, 118, 117, 0.1); border-color: rgba(255, 118, 117, 0.3); } /* G·∫•p & QT */
    .q1 .matrix-header { background: rgba(255, 118, 117, 0.2); color: #ff7675; }
    
    .q2 { background: rgba(9, 132, 227, 0.1); border-color: rgba(9, 132, 227, 0.3); } /* QT - Ko G·∫•p */
    .q2 .matrix-header { background: rgba(9, 132, 227, 0.2); color: #74b9ff; }
    
    .q3 { background: rgba(253, 203, 110, 0.1); border-color: rgba(253, 203, 110, 0.3); } /* G·∫•p - Ko QT */
    .q3 .matrix-header { background: rgba(253, 203, 110, 0.2); color: #fdcb6e; }
    
    .q4 { background: rgba(178, 190, 195, 0.1); border-color: rgba(178, 190, 195, 0.3); } /* R√°c */
    .q4 .matrix-header { background: rgba(178, 190, 195, 0.2); color: #b2bec3; }

    /* 3. V√πng th·∫£ (Drop Zone) */
    .matrix-content {
        flex: 1;
        overflow-y: auto;
        padding: 5px;
    }
    .matrix-content::-webkit-scrollbar { width: 4px; }
    .matrix-content::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }

    /* Hi·ªáu ·ª©ng khi k√©o task v√†o */
    .matrix-box.drag-over {
        border: 2px dashed var(--accent);
        background: rgba(255,255,255,0.05);
    }

    /* 4. Bi·∫øn Task th√†nh Card khi ·ªü trong Ma tr·∫≠n */
    .matrix-mode .row {
        background: var(--paper-bg);
        border: 1px solid var(--border);
        margin-bottom: 8px;
        padding: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        border-radius: 8px;
    }
    .matrix-mode .input-text { font-size: 12px; font-weight: 500; }

    /* Mobile Fix cho Ma tr·∫≠n */
    @media screen and (max-width: 768px) {
        #eisenhower-view {
            grid-template-columns: 1fr; /* 1 c·ªôt d·ªçc */
            height: auto;
        }
        .matrix-box { height: 200px; }
    }
    /* --- GIAO DI·ªÜN AI CHAT (D√ÅN V√ÄO PH·∫¶N STYLE) --- */
.ai-widget {
    position: fixed;
    bottom: 100px; left: 20px; /* V·ªã tr√≠ m·∫∑c ƒë·ªãnh */
    z-index: 9999;
    font-family: 'Inter', sans-serif;
}

.ai-icon-trigger {
    width: 60px; height: 60px;
    background: linear-gradient(135deg, #6c5ce7, #a29bfe);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: white; font-size: 28px;
    box-shadow: 0 10px 25px rgba(108, 92, 231, 0.5);
    cursor: move; /* Con tr·ªè di chuy·ªÉn */
    border: 2px solid white;
    transition: transform 0.2s;
    user-select: none;
    animation: pulse 3s infinite;
}
@keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(108, 92, 231, 0.4);} 70% {box-shadow: 0 0 0 15px rgba(108, 92, 231, 0);} 100% {box-shadow: 0 0 0 0 rgba(108, 92, 231, 0);} }

.ai-icon-trigger:hover { transform: scale(1.1); }
.ai-icon-trigger:active { transform: scale(0.95); }

.ai-chat-window {
    position: absolute; bottom: 80px; left: 0;
    width: 320px; height: 450px;
    background: rgba(30, 30, 46, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,0.1);
    display: none; /* M·∫∑c ƒë·ªãnh ·∫©n */
    flex-direction: column;
    overflow: hidden;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    animation: popUp 0.3s ease;
}
@keyframes popUp { from { opacity:0; transform:scale(0.8) translateY(20px); } to { opacity:1; transform:scale(1) translateY(0); } }

.ai-header {
    padding: 15px; background: rgba(255,255,255,0.05);
    display: flex; justify-content: space-between; align-items: center;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    color: white; font-weight: bold; cursor: move;
}

.ai-body {
    flex: 1; padding: 15px; overflow-y: auto;
    display: flex; flex-direction: column; gap: 10px;
}
.ai-body::-webkit-scrollbar { width: 4px; }
.ai-body::-webkit-scrollbar-thumb { background: #6c5ce7; border-radius: 4px; }

.msg { max-width: 80%; padding: 10px 14px; border-radius: 14px; font-size: 13px; line-height: 1.5; word-wrap: break-word; }
.msg.bot { align-self: flex-start; background: rgba(255,255,255,0.1); color: #dfe6e9; border-bottom-left-radius: 2px; }
.msg.user { align-self: flex-end; background: #6c5ce7; color: white; border-bottom-right-radius: 2px; }

.ai-input-area {
    padding: 15px; display: flex; gap: 10px; border-top: 1px solid rgba(255,255,255,0.1);
}
.ai-input {
    flex: 1; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: white;
    padding: 10px 15px; border-radius: 20px; outline: none; font-size: 13px;
}
.ai-send-btn {
    width: 40px; height: 40px; border-radius: 50%; border: none;
    background: #6c5ce7; color: white; cursor: pointer; transition: 0.2s;
}
.ai-send-btn:hover { background: #a29bfe; }
.typing-indicator { font-size: 11px; color: #a29bfe; margin-left: 15px; margin-bottom: 5px; display: none; font-style: italic; }
</style>
<div class="ai-widget" id="draggable-ai">
    <div class="ai-chat-window" id="ai-window">
        <div class="ai-header">
            <span onclick="renameAI()" style="cursor:pointer; display:flex; align-items:center; gap:8px">
                <i class="fas fa-robot"></i> <span id="ai-name-display">JARVIS</span> <i class="fas fa-pen" style="font-size:10px; opacity:0.5"></i>
            </span>
            <i class="fas fa-times" onclick="toggleAI()" style="cursor:pointer; opacity:0.7"></i>
        </div>
        
        <div class="ai-body" id="ai-messages">
            <div class="msg bot">Xin ch√†o! T√¥i ƒë√£ tr·ªü l·∫°i. B·∫°n c·∫ßn gi√∫p g√¨ kh√¥ng?</div>
        </div>
        
        <div class="typing-indicator" id="ai-typing">ƒêang suy nghƒ©...</div>
        
        <div class="ai-input-area">
            <input type="text" class="ai-input" id="ai-input" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeypress="handleAIEnter(event)">
            <button class="ai-send-btn" onclick="sendAIMessage()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div class="ai-icon-trigger" onclick="toggleAI()">
        <i class="fas fa-brain"></i>
    </div>
</div>
</body>
<script>
    /* =========================================
       MATRIX GOD MODE CONTROLLER
       ========================================= */
    
    // 1. D·ªØ li·ªáu l∆∞u v·ªã tr√≠ task (Task n√†o ·ªü √¥ n√†o)
    let matrixMap = JSON.parse(localStorage.getItem('LifeOS_MatrixMap')) || {};

    // 2. H√†m B·∫≠t/T·∫Øt ch·∫ø ƒë·ªô Ma tr·∫≠n
    window.toggleMatrix = function() {
        const todoList = document.getElementById('todo-list');
        const matrixView = document.getElementById('eisenhower-view');
        const btn = document.querySelector('button[onclick="toggleMatrix()"]');

        if (!matrixView.style.display || matrixView.style.display === 'none') {
            // -> CHUY·ªÇN SANG MA TR·∫¨N
            todoList.style.display = 'none';
            matrixView.style.display = 'grid';
            document.body.classList.add('matrix-mode'); // Th√™m class ƒë·ªÉ CSS bi·∫øt
            
            btn.innerHTML = '<i class="fas fa-list"></i> V·ªÅ Danh S√°ch';
            
            distributeTasksToMatrix(); // Ph√¢n ph·ªëi task v√†o c√°c √¥
        } else {
            // -> V·ªÄ DANH S√ÅCH TH∆Ø·ªúNG
            returnTasksToList(); // Tr·∫£ task v·ªÅ danh s√°ch c≈©
            
            todoList.style.display = 'block';
            matrixView.style.display = 'none';
            document.body.classList.remove('matrix-mode');
            
            btn.innerHTML = '<i class="fas fa-th-large"></i> Ch·∫ø ƒë·ªô Ma Tr·∫≠n';
        }
    };

    // 3. Ph√¢n ph·ªëi Task v√†o c√°c √¥ (D·ª±a tr√™n ID ƒë√£ l∆∞u)
    function distributeTasksToMatrix() {
        // L·∫•y t·∫•t c·∫£ c√°c row trong Todo List
        const rows = Array.from(document.querySelectorAll('#todo-list .row'));
        
        rows.forEach(row => {
            const rowId = row.id; 
            const savedQuad = matrixMap[rowId] || 'q2'; // M·∫∑c ƒë·ªãnh v√†o Q2 n·∫øu ch∆∞a x·∫øp
            
            // T√¨m √¥ t∆∞∆°ng ·ª©ng
            const targetBox = document.getElementById(`list-${savedQuad}`);
            if(targetBox) {
                targetBox.appendChild(row);
            }
        });
    }

    // 4. Tr·∫£ Task v·ªÅ danh s√°ch ch√≠nh khi t·∫Øt Ma tr·∫≠n
    function returnTasksToList() {
        const todoList = document.getElementById('todo-list');
        // Gom t·∫•t c·∫£ row ƒëang n·∫±m r·∫£i r√°c trong 4 √¥
        const rows = document.querySelectorAll('.matrix-content .row');
        
        // S·∫Øp x·∫øp l·∫°i theo ID (ƒë·ªÉ th·ª© t·ª± kh√¥ng b·ªã l·ªôn x·ªôn)
        const sortedRows = Array.from(rows).sort((a, b) => {
            // ID d·∫°ng 'todo_row_0', 'todo_row_1' -> l·∫•y s·ªë cu·ªëi ƒë·ªÉ sort
            const numA = parseInt(a.id.split('_').pop());
            const numB = parseInt(b.id.split('_').pop());
            return numA - numB;
        });

        sortedRows.forEach(row => todoList.appendChild(row));
    }

    // 5. LOGIC K√âO TH·∫¢ N√ÇNG CAO (DRAG & DROP)
    
    function allowDrop(ev) {
        ev.preventDefault();
        // Hi·ªáu ·ª©ng Visual khi k√©o v√†o
        ev.currentTarget.classList.add('drag-over');
    }

    // X·ª≠ l√Ω khi th·∫£ task v√†o √¥
    function dropToMatrix(ev, quadrantId) {
        ev.preventDefault();
        // X√≥a hi·ªáu ·ª©ng drag-over
        document.querySelectorAll('.matrix-box').forEach(b => b.classList.remove('drag-over'));

        // L·∫•y ID c·ªßa task ƒëang k√©o (t·ª´ bi·∫øn to√†n c·ª•c dragSrcEl c·ªßa code c≈©)
        if(!dragSrcEl) return;
        
        const rowId = dragSrcEl.id;
        
        // Ch·ªâ x·ª≠ l√Ω n·∫øu l√† Todo Row (kh√¥ng ph·∫£i Schedule hay Prio)
        if(rowId.includes('todo_row')) {
            // 1. Di chuy·ªÉn DOM sang √¥ m·ªõi
            const targetList = document.getElementById(`list-${quadrantId}`);
            targetList.appendChild(dragSrcEl);
            
            // 2. L∆∞u tr·∫°ng th√°i v√†o Memory & LocalStorage
            matrixMap[rowId] = quadrantId;
            localStorage.setItem('LifeOS_MatrixMap', JSON.stringify(matrixMap));
            
            // 3. Hi·ªáu ·ª©ng √¢m thanh & Toast
            if(typeof AUDIO_SYS !== 'undefined') AUDIO_SYS.sfx.click();
            
            let qName = "";
            if(quadrantId == 'q1') qName = "G·∫§P & QUAN TR·ªåNG";
            if(quadrantId == 'q2') qName = "QUAN TR·ªåNG (L√™n l·ªãch)";
            if(quadrantId == 'q3') qName = "GIAO VI·ªÜC";
            if(quadrantId == 'q4') qName = "X√ìA B·ªé / R√ÅC";
            
            showToast(`ƒê√£ chuy·ªÉn task sang: ${qName}`);
        }
    }

    // Fix l·ªói: Khi k√©o ra ngo√†i √¥ th√¨ m·∫•t hi·ªáu ·ª©ng
    document.querySelectorAll('.matrix-box').forEach(box => {
        box.addEventListener('dragleave', () => box.classList.remove('drag-over'));
    });

</script>
<script type="module">
    // 1. NH·∫¨P KH·∫®U C√îNG C·ª§ T·ª™ GOOGLE
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, serverTimestamp } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ‚ñº‚ñº‚ñº D√ÅN L·∫†I M√É CONFIG FIREBASE C·ª¶A B·∫†N V√ÄO ƒê√ÇY ‚ñº‚ñº‚ñº
    const firebaseConfig = {
        apiKey: "AIzaSyBEi0Yxa_w_Wh4PJXfc1ZIivJT-LhvlZfU",
        authDomain: "life-os-planner.firebaseapp.com",
        projectId: "life-os-planner",
        storageBucket: "life-os-planner.firebasestorage.app",
        messagingSenderId: "929281569298",
        appId: "1:929281569298:web:6e18393546f84d6af61ecb",
        measurementId: "G-7KNWE4XKSD"
    };
    // ‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤

    // Kh·ªüi ƒë·ªông h·ªá th·ªëng
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let cloudKnowledge = []; // B·ªô nh·ªõ t·∫°m c·ªßa AI

    console.log(">> ƒêang k·∫øt n·ªëi n√£o b·ªô...");

    // --- H√ÄM T·∫¢I KI·∫æN TH·ª®C T·ª™ M√ÇY ---
    async function downloadBrain() {
        try {
            // L·∫•y d·ªØ li·ªáu t·ª´ b·ªô s∆∞u t·∫≠p "knowledge" tr√™n Firebase
            const querySnapshot = await getDocs(collection(db, "knowledge"));
            cloudKnowledge = [];
            querySnapshot.forEach((doc) => {
                cloudKnowledge.push(doc.data());
            });
            console.log(`>> ƒê√£ t·∫£i xong ${cloudKnowledge.length} ki·∫øn th·ª©c m·ªõi!`);
        } catch (e) {
            console.error("L·ªói t·∫£i n√£o b·ªô:", e);
        }
    }
    // T·∫£i ki·∫øn th·ª©c ngay khi b·∫≠t web
    downloadBrain();


    // --- C√ÅC LOGIC C≈® (Giao di·ªán & K√©o th·∫£) ---
    window.aiName = localStorage.getItem('LifeOS_AIName') || "JARVIS";
    const widget = document.getElementById('draggable-ai');
    const aiWindow = document.getElementById('ai-window');
    const nameDisplay = document.getElementById('ai-name-display');
    if(nameDisplay) nameDisplay.innerText = window.aiName;

    // Load v·ªã tr√≠
    const savedPos = JSON.parse(localStorage.getItem('LifeOS_AIPos'));
    if(savedPos && widget) {
        widget.style.left = savedPos.x;
        widget.style.top = savedPos.y;
        widget.style.bottom = 'auto';
    }

    // Logic K√©o th·∫£
    let isDragging = false;
    let startX, startY, initialLeft, initialTop;
    let hasMoved = false;

    window.initDrag = function() {
        const dragHandles = [document.querySelector('.ai-icon-trigger'), document.querySelector('.ai-header')];
        dragHandles.forEach(handle => {
            if(handle) {
                handle.addEventListener('mousedown', dragStart);
                handle.addEventListener('touchstart', dragStart, {passive: false});
            }
        });
    }

    function dragStart(e) {
        if(e.target.classList.contains('fa-times') || e.target.closest('span[onclick]')) return;
        isDragging = true; hasMoved = false;
        const clientX = e.clientX || e.touches[0].clientX;
        const clientY = e.clientY || e.touches[0].clientY;
        startX = clientX; startY = clientY;
        const rect = widget.getBoundingClientRect();
        initialLeft = rect.left; initialTop = rect.top;
        document.addEventListener('mousemove', dragMove);
        document.addEventListener('mouseup', dragEnd);
        document.addEventListener('touchmove', dragMove, {passive: false});
        document.addEventListener('touchend', dragEnd);
    }

    function dragMove(e) {
        if(!isDragging) return;
        e.preventDefault();
        const clientX = e.clientX || e.touches[0].clientX;
        const clientY = e.clientY || e.touches[0].clientY;
        const dx = clientX - startX; const dy = clientY - startY;
        if(Math.abs(dx) > 5 || Math.abs(dy) > 5) hasMoved = true;
        widget.style.left = `${initialLeft + dx}px`;
        widget.style.top = `${initialTop + dy}px`;
        widget.style.bottom = 'auto';
    }

    function dragEnd() {
        isDragging = false;
        document.removeEventListener('mousemove', dragMove);
        document.removeEventListener('mouseup', dragEnd);
        document.removeEventListener('touchmove', dragMove);
        document.removeEventListener('touchend', dragEnd);
        if(hasMoved) localStorage.setItem('LifeOS_AIPos', JSON.stringify({ x: widget.style.left, y: widget.style.top }));
    }

    window.toggleAI = function() {
        if(hasMoved) return;
        if(aiWindow.style.display === 'flex') aiWindow.style.display = 'none';
        else { aiWindow.style.display = 'flex'; document.getElementById('ai-input')?.focus(); }
    };

    window.handleAIEnter = function(e) { if(e.key === 'Enter') window.sendAIMessage(); };
    
    window.renameAI = function() {
        const newName = prompt("ƒê·∫∑t t√™n m·ªõi cho AI:", window.aiName);
        if(newName) {
            window.aiName = newName;
            localStorage.setItem('LifeOS_AIName', window.aiName);
            document.getElementById('ai-name-display').innerText = window.aiName;
            addBotMsg(`ƒê√£ ƒë·ªïi t√™n th√†nh c√¥ng. ${window.aiName} nghe l·ªánh!`);
        }
    };

    // --- LOGIC G·ª¨I & X·ª¨ L√ù TH√îNG MINH ---
    window.sendAIMessage = async function() {
        const input = document.getElementById('ai-input');
        const text = input.value.trim();
        if(!text) return;

        addUserMsg(text);
        input.value = '';

        // 1. G·ª≠i tin nh·∫Øn l√™n Firebase (Thu th·∫≠p d·ªØ li·ªáu)
        try {
            await addDoc(collection(db, "chat_logs"), {
                msg: text,
                user: navigator.userAgent,
                time: serverTimestamp()
            });
        } catch(e) {}

        // 2. AI Suy nghƒ©
        document.getElementById('ai-typing').style.display = 'block';
        setTimeout(() => {
            document.getElementById('ai-typing').style.display = 'none';
            processSmartResponse(text);
            if(typeof AUDIO_SYS !== 'undefined' && AUDIO_SYS.sfx) AUDIO_SYS.sfx.type(); 
        }, 600 + Math.random() * 800);
    };

    function addUserMsg(text) {
        const div = document.createElement('div'); div.className = 'msg user'; div.innerText = text;
        const body = document.getElementById('ai-messages'); 
        if(body) { body.appendChild(div); body.scrollTop = body.scrollHeight; }
    }

    function addBotMsg(text) {
        const div = document.createElement('div'); div.className = 'msg bot'; div.innerHTML = text;
        const body = document.getElementById('ai-messages');
        if(body) { body.appendChild(div); body.scrollTop = body.scrollHeight; }
    }

    // --- B·ªò N√ÉO H·ª¢P NH·∫§T (C≈® + M·ªöI) ---
    async function processSmartResponse(input) {
        const text = input.toLowerCase();

        // 1. Ki·ªÉm tra t√≠nh to√°n (Math)
        if (/[0-9]/.test(text) && /[\+\-\*\/]/.test(text)) {
            try {
                const mathStr = text.replace(/[^0-9\+\-\*\/\.\(\)]/g, '');
                if(mathStr) { addBotMsg(`üßÆ K·∫øt qu·∫£: <b>${eval(mathStr)}</b>`); return; }
            } catch(e) {}
        }

        // 2. Ki·ªÉm tra b·ªô n√£o ƒë√°m m√¢y (Cloud Knowledge)
        // T√¨m xem c√≥ t·ª´ kh√≥a n√†o kh·ªõp kh√¥ng
        for (let item of cloudKnowledge) {
            // item.keys l√† chu·ªói c√°c t·ª´ kh√≥a, v√≠ d·ª•: "gi√°, ti·ªÅn, bao nhi√™u"
            const keys = item.keys.split(',').map(k => k.trim().toLowerCase());
            for (let k of keys) {
                if (text.includes(k) && k.length > 0) {
                    addBotMsg(item.answer);
                    return;
                }
            }
        }

        // 3. Ki·∫øn th·ª©c c∆° b·∫£n (Hardcode)
        const BASIC_KNOWLEDGE = [
            { k: ['ch√†o', 'hi', 'hello'], a: "Xin ch√†o! M√¨nh l√† AI c·ªßa b·∫°n ƒë√¢y." },
            { k: ['t√™n g√¨', 'l√† ai'], a: `M√¨nh l√† ${window.aiName}, tr·ª£ l√Ω ·∫£o ch·∫°y tr√™n n·ªÅn web.` },
            { k: ['m·ªát', 'bu·ªìn'], a: "C·ªë l√™n nh√©! Ngh·ªâ ng∆°i m·ªôt ch√∫t r·ªìi l√†m ti·∫øp." }
        ];

        for (let item of BASIC_KNOWLEDGE) {
            for (let k of item.k) {
                if (text.includes(k)) { addBotMsg(item.a); return; }
            }
        }

        // 4. N·∫øu kh√¥ng bi·∫øt -> Ghi l·∫°i c√¢u h·ªèi l·∫° v√†o Firebase ƒë·ªÉ ch·ªß nh√¢n d·∫°y
        try {
            await addDoc(collection(db, "missing_data"), {
                question: text,
                time: serverTimestamp()
            });
        } catch(e) {}

        addBotMsg("C√¢u n√†y m√¨nh ch∆∞a ƒë∆∞·ª£c h·ªçc. M√¨nh ƒë√£ ghi l·∫°i ƒë·ªÉ ch·ªß nh√¢n d·∫°y th√™m!");
    }

    window.initDrag();
</script>
</body>
</html>
